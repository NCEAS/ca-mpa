
# Read data
################################################################################

# Clear workspace
rm(list = ls())

# Packages
library(tidyverse)
library(countrycode)
library(tidycensus)

# Directories
basedir <- "/Volumes/GoogleDrive/.shortcut-targets-by-id/1kCsF8rkm1yhpjh2_VMzf8ukSPf9d4tqO/MPA Network Assessment: Working Group Shared Folder/data/sync-data/"
indir <- file.path(basedir, "census_data/raw")
outdir <- file.path(basedir, "census_data/processed")
plotdir <- "data/census_data/figures"

# Package
# https://walker-data.com/tidycensus/articles/basic-usage.html

# Set API key
tidycensus::census_api_key(key="974c34380d8224622c765f34050e53a382511e33", install=T, overwrite = T)

# Read key
keydir <- "/Volumes/GoogleDrive/.shortcut-targets-by-id/1kCsF8rkm1yhpjh2_VMzf8ukSPf9d4tqO/MPA Network Assessment: Working Group Shared Folder/project-documents/MPA Performance/Question 4 network performance/"
dataset_key <- readxl::read_excel(file.path(keydir, "Social Vulnerability metrics.xlsx"), sheet=3) %>% 
  janitor::clean_names()


# Get block-level data
################################################################################

# Female codes
female_codes <- readxl::read_excel(file.path(keydir, "Social Vulnerability metrics.xlsx"), sheet=4) %>% 
  pull("Females in work force")

# Variables to get
var_do <- c(dataset_key$name, dataset_key$denominator, female_codes) %>% unique() %>% sort()
var_do <- var_do[var_do!="multiple, see calculatin" & !is.na(var_do)]

# Get data
acs_data <- get_acs(geography = "tract",
                    variables = var_do,
                    state="California",
                    year = 2010,
                    geometry = F)

# Did I get it all?
var_done <- acs_data$variable %>% unique()
var_do[!var_do %in% var_done]

# Get tract data
tracts_orig <- get_acs(geography = "tract",
                       variable="B25064_001",
                       state="California",
                       year = 2010,
                       geometry = T)

# Format tracts
tracts <- tracts_orig %>% 
  janitor::clean_names("snake") %>% 
  select(geoid, name, geometry)


# Perform calculations
################################################################################

# Indicators to reverse (so that low values are bad and high values are good)
indicators_to_reverse <- c("Percent of families\nbelow poverty level",
                           "Percent of households with\ncash public assistance income",
                           "Percent of households with\nfemale householders\n(no husband present)",
                           "Percent of housing units\nthat are mobile homes",
                           "Percent of population\nthat speaks English\nless than very well",
                           "Percent of population\nunder 6-years-old")

# Build data
acs_data_wide <- acs_data %>% 
  # Rename
  janitor::clean_names("snake") %>% 
  # Remove error
  select(-moe) %>% 
  # Spread
  spread(key="variable", value="estimate") %>% 
  # Derive new ones
  mutate(perc_work_force=(B12006_004+B12006_009+B12006_015+B12006_020+B12006_026+B12006_031+B12006_037+B12006_042+B12006_048+B12006_053)/B12006_001,
         perc_work_force_female=(B12006_009+B12006_020+B12006_031+B12006_042+B12006_053)/(B12006_008+B12006_019+B12006_030+B12006_041+B12006_052), # Percent females in Labor force
         B10054_013_div_B10054_001=B10054_013/B10054_001,
         B02001_002_div_B02001_001=B02001_002/B02001_001,
         B05009_002_div_B05009_001=B05009_002/B05009_001,
         B17010_002_div_B17010_001=B17010_002/B17010_001,
         B19058_002_div_B19058_001=B19058_002/B19058_001,
         B11003_015_div_B11003_001=B11003_015/B11003_001,
         mobile_homes=(B11011_006+B11011_011+B11011_015+B11011_019)/B11011_001) %>% 
  # Select
  select(geoid, name, 
         B25064_001,
         B25088_002,
         B25018_001,
         # B19055_001,
         # B11011_001,
         # B17010_001,
         # B01001_026,
         # B10054_001,
         # B01001_001,
         # B25002_001,
         perc_work_force,
         perc_work_force_female,
         B11003_015_div_B11003_001,
         B10054_013_div_B10054_001,
         B02001_002_div_B02001_001,
         B05009_002_div_B05009_001,
         B17010_002_div_B17010_001,
         B19058_002_div_B19058_001,
         mobile_homes) %>% 
  # Gather
  gather(key="indicator", value="value", 3:ncol(.)) %>% 
  # Rename indicators
  mutate(indicator=recode(indicator,
                          "B25064_001"="Median monthly\nrent (USD)",
                          "B25088_002"="Median monthly\nmortgage (USD)",
                          "B25018_001"="Median number\nof rooms per housing unit",
                          "B11003_015_div_B11003_001"="Percent of households with\nfemale householders\n(no husband present)",
                          "mobile_homes"="Percent of housing units\nthat are mobile homes",
                          "perc_work_force"="Percent of population\nin labor force",
                          "perc_work_force_female"="Percent of labor force\nthat is female",
                          # "B19055_001"="Total households",
                          # "B11011_001"="Total number\nof households",
                          # "B17010_001"="Total number\nof families",
                          # "B01001_026"="Total number\nof females",
                          # "B10054_001"="Total population size",
                          # "B01001_001"="Total population ",
                          # "B25002_001"="Total number of\nhousing units"))
                          "B10054_013_div_B10054_001"="Percent of population\nthat speaks English\nless than very well",
                          "B02001_002_div_B02001_001"="Percent of population\nthat is white alone",
                          "B05009_002_div_B05009_001"="Percent of population\nunder 6-years-old",
                          "B17010_002_div_B17010_001"="Percent of families\nbelow poverty level",
                          "B19058_002_div_B19058_001"="Percent of households with\ncash public assistance income")) %>% 
  # Z-score
  group_by(indicator) %>% 
  mutate(value_z=scale(value, center=T, scale=T)) %>% 
  ungroup() %>% 
  # Reverse some
  mutate(value_z_dir=ifelse(indicator %in% indicators_to_reverse, value_z * -1, value_z))


# Stats
stats <- acs_data_wide %>% 
  group_by(indicator) %>% 
  summarize(low_val=min(value, na.rm=T),
            high_val=max(value, na.rm=T)) %>% 
  ungroup()


# Indicator key
indicator_key <- dataset_key %>% 
  # Reduce to indicators
  filter(!is.na(index)) %>% 
  select(variable_description, direction) %>% 
  unique() %>% 
  # Recode indicator
  rename(indicator=variable_description) %>% 
  mutate(indicator=recode(indicator,
                          "Median gross rent"="Median monthly\nrent (USD)",
                          "Median mortgage, monthly payment"="Median monthly\nmortgage (USD)",
                          "Median number of rooms"="Median number\nof rooms per housing unit",
                          "Percent female householder"="Percent of households with\nfemale householders\n(no husband present)",
                          "Percent Mobile Homes"="Percent of housing units\nthat are mobile homes",
                          "Percent population in the labor force"="Percent of population\nin labor force",
                          "Percent females in Labor force"="Percent of labor force\nthat is female",
                          "Percent speak English less than very well"="Percent of population\nthat speaks English\nless than very well",
                          "Percent White Alone\r\npopulation"="Percent of population\nthat is white alone",
                          "Percent population age under 6"="Percent of population\nunder 6-years-old",
                          "Per cent of families below poverty level"="Percent of families\nbelow poverty level",
                          "Percent households with cash public assistance income"="Percent of households with\ncash public assistance income")) %>% 
  # Labels
  mutate(low_label=ifelse(direction=="negative", "More\nvulnerable", "Less\nvulnerable"),
         high_label=ifelse(direction=="negative", "Less\nvulnerable", "More\nvulnerable"),
         low_color=ifelse(low_label=="More\nvulnerable", "red", "blue"),
         high_color=ifelse(high_label=="More\nvulnerable", "red", "blue")) %>% 
  # Add values
  left_join(stats, by="indicator")

# Save data
save(acs_data, acs_data_wide, stats, indicator_key, file=file.path(outdir, "ACS_vulnerability_indicators.Rdata"))


# Visualize distribution data
################################################################################

# Setup theme
my_theme <-  theme(axis.text=element_text(size=7),
                   axis.title=element_text(size=8),
                   legend.text=element_text(size=7),
                   legend.title=element_text(size=8),
                   strip.text=element_text(size=7),
                   # Gridlines
                   panel.grid.major = element_blank(), 
                   panel.grid.minor = element_blank(),
                   panel.background = element_blank(), 
                   axis.line = element_line(colour = "black"),
                   # Legend
                   legend.background = element_rect(fill=alpha('blue', 0)))


# Plot data distribution
g <- ggplot(acs_data_wide, aes(x=value)) +
  # Density
  facet_wrap(~indicator, ncol=4, scales="free") +
  geom_density() + 
  # Plot labels
  geom_text(data=indicator_key, mapping=aes(x=low_val, label=low_label, color=low_label), y=0, hjust=0, vjust=0, size=2.4) +
  geom_text(data=indicator_key, mapping=aes(x=high_val, label=high_label, color=high_label), y=0, hjust=1, vjust=0, size=2.4) +
  # Labels
  labs(x="Value", y="Density") +
  scale_color_manual(name="", values=c("blue", "red"), guide="none") +
  # Theme
  theme_bw() + my_theme +
  theme(axis.text.y=element_blank())
g

# Export
ggsave(g, filename=file.path(plotdir, "FigX_census_indicators_dist.png"), 
       width=6.5, height=6.5, units="in", dpi=600)



# Visualize distribution data
################################################################################

# Indicators
indicators <- sort(unique(acs_data_wide$indicator))

# Add spatial info
acs_data_wide_sf <- acs_data_wide %>% 
  left_join(tracts) %>% 
  sf::st_as_sf()

# Theme
map_theme <-  theme(axis.text=element_text(size=6),
                   axis.title=element_blank(),
                   legend.text=element_text(size=6),
                   legend.title=element_text(size=8),
                   strip.text=element_text(size=8),
                   plot.title=element_text(size=10),
                   axis.text.y = element_text(angle = 90, hjust = 0.5),
                   # Gridlines
                   panel.grid.major = element_blank(), 
                   panel.grid.minor = element_blank(),
                   panel.background = element_blank(), 
                   axis.line = element_line(colour = "black"),
                   # Legend
                   legend.background = element_rect(fill=alpha('blue', 0)))

map_theme_sm <-  theme(axis.text=element_text(size=4),
                    axis.title=element_blank(),
                    legend.text=element_text(size=5),
                    legend.title=element_text(size=5),
                    plot.title=element_blank(),
                    axis.text.y = element_text(angle = 90, hjust = 0.5),
                    # Gridlines
                    panel.grid.major = element_blank(), 
                    panel.grid.minor = element_blank(),
                    panel.background = element_blank(), 
                    axis.line = element_line(colour = "black"),
                    # Legend
                    legend.background = element_rect(fill=alpha('blue', 0)))


# Loop throuhg indicators
plot_list <- list()
for(i in 1:length(indicators)){
  
  # Indicator
  indicator_do <- indicators[i]

  # Subset data
  data_do <- acs_data_wide_sf %>% 
    filter(indicator==indicator_do)
  
  # Plot
  g <- ggplot(data_do, mapping=aes(fill=value)) +
    geom_sf(lwd=0) +
    # Crop
    coord_sf(xlim = c(-124, -114.5), ylim = c(32.8, 41.8)) +
    # Legend
    scale_fill_gradientn(name=indicator_do, 
                         colors=RColorBrewer::brewer.pal(9, "YlOrRd")) +
    guides(fill = guide_colorbar(ticks.colour = "black", frame.colour = "black",
                                 title.position="top")) +
    # Theme
    theme_bw() + map_theme_sm +
    theme(legend.position=c(0.7,  0.75),
          # legend.direction = "horizontal",
          legend.key.size = unit(0.2, "cm"))
  g
  
  # Export
  # figname <- paste0("FigX_", indicator_do, ".png")
  # ggsave(g, filename=file.path(plotdir, figname), 
  #        width=3.8, height=4.5, units="in", dpi=600)
  
  # Save
  plot_list[[i]] <- g
  
}


# Plots
g1 <- plot_list[[1]]
g2 <- plot_list[[2]]
g3 <- plot_list[[3]]
g4 <- plot_list[[4]]
g5 <- plot_list[[5]]
g6 <- plot_list[[6]]
g7 <- plot_list[[7]]
g8 <- plot_list[[8]]
g9 <- plot_list[[9]]
g10 <- plot_list[[10]]
g11 <- plot_list[[11]]
g12 <- plot_list[[12]]

g <- gridExtra::grid.arrange(g1, g2, g3, g4, g5, g6, g7, g8, g9, g10, g11, g12, ncol=4)
ggsave(g, filename=file.path(plotdir, "FigX_social_vulnernability_indicators_map.png"),
       width=6.5, height=5.5, units="in", dpi=600)


# Visualize z-score
################################################################################

# Index
index <- acs_data_wide %>% 
  group_by(geoid, name) %>% 
  summarise(n=n(),
            value=mean(value_z_dir, na.rm=T)) %>% 
  ungroup()


# Spatialize index
index_sf <- tracts %>% 
  left_join(index) %>% 
  sf::st_transform("+proj=longlat +datum=WGS84")

# Plot
g <- ggplot(index_sf, mapping=aes(fill=value)) +
  geom_sf(lwd=0.05, color="grey30") +
  # Crop
  coord_sf(xlim = c(-124, -114.5), ylim = c(32.8, 41.8)) +
  # Legend
  scale_fill_gradient2(name="Social vulnerability index\n(red=more vulnerable\nblue=less vulnerable)", 
                       midpoint = 0, mid="white", high="blue", low="red") +
  guides(fill = guide_colorbar(ticks.colour = "black", frame.colour = "black")) +
  # Theme
  theme_bw() + map_theme +
  theme(legend.position=c(0.75, 0.75))
g

# Export
ggsave(g, filename=file.path(plotdir, "FigX_social_vulnerability index.png"), 
       width=3.8, height=4.5, units="in", dpi=600)


# Rasterize and compute MPA statistic
################################################################################

# Read MPAs
mpas_50km <- readRDS(file.path(basedir, "gis_data/processed", "CA_MPA_polygons_50km_buffer.Rds"))

# Read pop raster
pop <- readRDS(file=file.path(outdir, "CA_2010_census_tot_pop_by_block_raster.Rds")) %>% 
  select(long_dd, lat_dd, people) %>% 
  raster::rasterFromXYZ(crs = "+proj=longlat +datum=WGS84") 

# Unweighted
#############################

# Index raster
index_raster <- fasterize::fasterize(sf=index_sf, raster = pop, field="value", fun="first")

# Mean vulnerability within X km of MPA
data <- raster::extract(x=index_raster, y=mpas_50km, method="simple", fun=mean, na.rm=T)

# Convert data to dataframe
data_df <- data %>% 
  as.data.frame() %>% 
  rename("index"="V1") %>% 
  mutate(mpa=mpas_50km$name)

# Weighted
#############################

# Multiply index by weights
index_times_pop <- index_raster * pop

# Sum index by weights within X km of MPA
index_times_pop_tot <- raster::extract(x=index_times_pop, y=mpas_50km, method="simple", fun=sum, na.rm=T)

# Sum population with X km of MPA
pop_tot <- raster::extract(x=pop, y=mpas_50km, method="simple", fun=sum, na.rm=T)

# Calculate pop-weighted average
index_wt <- index_times_pop_tot / pop_tot

# Merge
#############################

# Add data to MPAs
data_out <- mpas_50km %>% 
  sf::st_drop_geometry() %>% 
  select(name, long_dd, lat_dd) %>% 
  mutate(index=data_df$index,
         index_wt=index_wt %>% as.numeric())

# Are the weighted and unweighted indices correlated?
plot(index_wt ~ index, data_out)


# Plot
g <- ggplot(index_sf, mapping=aes(fill=value)) +
  geom_sf(lwd=0.05, color="grey30") +
  # Add MPAs
  geom_point(data_out, mapping=aes(x=long_dd, y=lat_dd, fill=index), 
             pch=21, size=2, inherit.aes = F) +
  # Crop
  coord_sf(xlim = c(-124, -114.5), ylim = c(32.8, 41.8)) +
  # Legend
  scale_fill_gradient2(name="Social vulnerability index\n(red=more vulnerable\nblue=less vulnerable)", 
                       midpoint = 0, mid="white", high="blue", low="red") +
  guides(fill = guide_colorbar(ticks.colour = "black", frame.colour = "black")) +
  # Theme
  theme_bw() + map_theme +
  theme(legend.position=c(0.75, 0.79))
g

# Export
ggsave(g, filename=file.path(plotdir, "FigX_social_vulnerability_index_mpas.png"), 
       width=3.8, height=4.5, units="in", dpi=600)

# Export
saveRDS(data_out, file=file.path(outdir, "social_vulnerability_index_by_mpa.Rds"))


# Compare to pop data
################################################################################

# Read pop data
pop_50km <- readRDS(file.path(outdir, "MPA_population_within_50km.Rds")) %>% 
  left_join(data_out %>% select(name, index))

# Plot
g <- ggplot(pop_50km, aes(x=npeople_50km/1e6, y=index)) +
  geom_point() +
  # Reference line
  geom_hline(yintercept=0) +
  # Labels
  labs(x="Million of people\nwithin 50 km", 
       y="Average social vulnerability\nwithin 50 km") +
  # Theme
  theme_bw() + my_theme
g

# Export
ggsave(g, filename=file.path(plotdir, "FigX_social_vulnerability_vs_pop_size.png"), 
       width=3.5, height=3.5, units="in", dpi=600)



