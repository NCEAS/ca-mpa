
# Read data
################################################################################

# Clear workspace
rm(list = ls())

# Packages
library(tidyverse)
library(countrycode)
library(tidycensus)

# Directories
basedir <- "/Volumes/GoogleDrive/.shortcut-targets-by-id/1kCsF8rkm1yhpjh2_VMzf8ukSPf9d4tqO/MPA Network Assessment: Working Group Shared Folder/data/sync-data/"
indir <- file.path(basedir, "census_data/raw")
outdir <- file.path(basedir, "census_data/processed")
plotdir <- "data/census_data/figures"

# Package
# https://walker-data.com/tidycensus/articles/basic-usage.html

# Set API key
tidycensus::census_api_key(key="974c34380d8224622c765f34050e53a382511e33", install=T, overwrite = T)

# Read key
keydir <- "/Volumes/GoogleDrive/.shortcut-targets-by-id/1kCsF8rkm1yhpjh2_VMzf8ukSPf9d4tqO/MPA Network Assessment: Working Group Shared Folder/project-documents/MPA Performance/Question 4 network performance/"
dataset_key <- readxl::read_excel(file.path(keydir, "Social Vulnerability metrics.xlsx"), sheet=3) %>% 
  janitor::clean_names()


# Get block-level data
################################################################################

# Female codes
female_codes <- readxl::read_excel(file.path(keydir, "Social Vulnerability metrics.xlsx"), sheet=4) %>% 
  pull("Females in work force")

# Variables to get
var_do <- c(dataset_key$name, dataset_key$denominator, female_codes) %>% unique()
var_do <- var_do[var_do!="various, see calculation" & !is.na(var_do)]

# Get data
acs_data <- get_acs(geography = "tract",
                    variables = var_do,
                    state="California",
                    year = 2010,
                    geometry = F)

# Did I get it all?
var_done <- acs_data$variable %>% unique()
var_do[!var_do %in% var_done]

# Get tract data
tracts_orig <- get_acs(geography = "tract",
                       variable="B25064_001",
                       state="California",
                       year = 2010,
                       geometry = T)

# Format tracts
tracts <- tracts_orig %>% 
  janitor::clean_names("snake") %>% 
  select(geoid, name, geometry)


# Perform calculations
################################################################################

# turn female household head into percent

# Build data
acs_data_wide <- acs_data %>% 
  # Rename
  janitor::clean_names("snake") %>% 
  # Remove error
  select(-moe) %>% 
  # Spread
  spread(key="variable", value="estimate") %>% 
  # Derive new ones
  mutate(perc_work_force_female=(B12006_009+B12006_020+B12006_031+B12006_042+B12006_053)/(B12006_008+B12006_019+B12006_030+B12006_041+B12006_052), # Percent females in Labor force
         B10054_013_div_B10054_001=B10054_013/B10054_001,
         B02001_002_div_B01001_001=B02001_002/B01001_001,
         B05009_002_div_B10054_001=B05009_002/B10054_001,
         B17010_002_div_B17010_001=B17010_002/B17010_001,
         B19058_002_div_B11011_001=B19058_002/B11011_001,
         mobile_homes=(B11011_006+B11011_011+B11011_015+B11011_019)/B11011_001) %>% 
  # Select
  select(geoid, name, 
         B25064_001,
         B25088_002,
         B25018_001,
         B11003_015,
         # B19055_001,
         B11011_001,
         B17010_001,
         B01001_026,
         B10054_001,
         # B01001_001,
         B25002_001,
         perc_work_force_female,
         B10054_013_div_B10054_001,
         B02001_002_div_B01001_001,
         B05009_002_div_B10054_001,
         B17010_002_div_B17010_001,
         B19058_002_div_B11011_001,
         mobile_homes) %>% 
  # Gather
  gather(key="indicator", value="value", 3:ncol(.)) %>% 
  # Rename indicators
  mutate(indicator=recode(indicator,
                          "B25064_001"="Median monthly\nrent (USD)",
                          "B25088_002"="Median monthly\nmortgage (USD)",
                          "B25018_001"="Median number\nof rooms per housing unit",
                          "B11003_015"="Number of female householders\n(no husband present)",
                          # "B19055_001"="Total households",
                          "B11011_001"="Total number\nof households",
                          "B17010_001"="Total number\nof families",
                          "B01001_026"="Total number\nof females",
                          "B10054_001"="Total population size",
                          # "B01001_001"="Total population ",
                          "B25002_001"="Total number of\nhousing units",
                          "mobile_homes"="Percent of housing units\nthat are mobile homes",
                          "perc_work_force_female"="Percent of labor force\nthat is female",
                          "B10054_013_div_B10054_001"="Percent of population\nthat speaks English less than very well",
                          "B02001_002_div_B01001_001"="Percent of population\nthat is white alone",
                          "B05009_002_div_B10054_001"="Number of people\nunder 6-years-old",
                          "B17010_002_div_B17010_001"="Percent of families\nbelow poverty level",
                          "B19058_002_div_B11011_001"="Percent of households with\ncash public assistance income"))



# Visualize distribution data
################################################################################

# Setup theme
my_theme <-  theme(axis.text=element_text(size=7),
                   axis.title=element_text(size=8),
                   legend.text=element_text(size=7),
                   legend.title=element_text(size=8),
                   strip.text=element_text(size=6),
                   # Gridlines
                   panel.grid.major = element_blank(), 
                   panel.grid.minor = element_blank(),
                   panel.background = element_blank(), 
                   axis.line = element_line(colour = "black"),
                   # Legend
                   legend.background = element_rect(fill=alpha('blue', 0)))


# Plot data distribution
g <- ggplot(acs_data_wide, aes(x=value)) +
  # Density
  facet_wrap(~indicator, ncol=4, scales="free") +
  geom_density() + 
  # Labels
  labs(x="Value", y="Density") +
  # Theme
  theme_bw() + my_theme +
  theme(axis.text.y=element_blank())
g

# Export
ggsave(g, filename=file.path(plotdir, "FigX_census_indicators_dist.png"), 
       width=6.5, height=6.5, units="in", dpi=600)



# Visualize distribution data
################################################################################

# Indicators
indicators <- sort(unique(acs_data_wide$indicator))

# Add spatial info
acs_data_wide_sf <- acs_data_wide %>% 
  left_join(tracts) %>% 
  sf::st_as_sf()

# Theme
my_theme <-  theme(axis.text=element_text(size=6),
                   axis.title=element_text(size=8),
                   legend.text=element_text(size=6),
                   legend.title=element_text(size=8),
                   strip.text=element_text(size=8),
                   plot.title=element_text(size=10),
                   axis.text.y = element_text(angle = 90, hjust = 0.5),
                   # Gridlines
                   panel.grid.major = element_blank(), 
                   panel.grid.minor = element_blank(),
                   panel.background = element_blank(), 
                   axis.line = element_line(colour = "black"),
                   # Legend
                   legend.background = element_rect(fill=alpha('blue', 0)))

# Loop throuhg indicators
for(i in 1:length(indicators)){
  
  # Indicator
  indicator_do <- indicators[i]

  # Subset data
  data_do <- acs_data_wide_sf %>% 
    filter(indicator==indicator_do)
  
  # Plot
  g <- ggplot(data_do, mapping=aes(fill=value)) +
    geom_sf(lwd=0) +
    # Crop
    coord_sf(xlim = c(-124.5, -114), ylim = c(32.5, 42)) +
    # Legend
    scale_fill_gradientn(name=indicator_do, 
                         colors=RColorBrewer::brewer.pal(9, "YlOrRd")) +
    guides(fill = guide_colorbar(ticks.colour = "black", frame.colour = "black")) +
    # Theme
    theme_bw() + my_theme +
    theme(legend.position=c(0.8, 0.8))
  g
  
  # Export
  figname <- paste0("FigX_", indicator_do, ".png")
  ggsave(g, filename=file.path(plotdir, figname), 
         width=4.0, height=4.5, units="in", dpi=600)
  
}

