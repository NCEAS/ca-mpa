---
title: "Community_data_processing"
author: "Joshua G. Smith"
date: '2022-06-16'
output: html_document
---

#load packages
```{r}
require(dplyr)
require(stringr)
require(tidyr)
require(janitor)
```


#Process CCFRP data

```{r}
# ccfrp -------------------------------------------------------------------

#load species level mean fish CPUE
data_path <- "/home/shares/ca-mpa/data/sync-data/monitoring/monitoring_ccfrp/CCFRP_derived_data_tables_DataONE"
input_file <- "CCFRP_derived_effort_table.csv" 
CPUE_raw <- read.csv(file.path(data_path, input_file))

#reshape and clean up
CCFRP_CPUE <- CPUE_raw %>%
  mutate(affiliated_mpa = paste(Area,"smr"), #all ccfrp MPAs are defacto SMRs per PI
         mpa_designation = ifelse(MPA_Status == "MPA","smr", MPA_Status))
  
CCFRP_CPUE$mpa_designation <- tolower(CCFRP_CPUE$mpa_designation)
CCFRP_CPUE$mpa_designation <- tolower(CCFRP_CPUE$mpa_designation)

CCFRP_CPUE <- CCFRP_CPUE %>%
                  dplyr::select(year=Year, affiliated_mpa, mpa_designation, Grid_Cell_ID, Common_Name, CPUE_catch_per_angler_hour)%>%
                  mutate(mpa_class="smr", 
                         group="ccfrp") %>%
                  group_by(group, year, affiliated_mpa, mpa_class, mpa_designation, Grid_Cell_ID, Common_Name)%>%
                  summarise(CPUE_mean = mean(CPUE_catch_per_angler_hour))%>%  #some species in the raw data have duplicate entries.
                  ungroup() %>%
                  tidyr::pivot_wider(names_from = Common_Name, 
                                     values_from = CPUE_mean) %>%
                  janitor::clean_names()
              
CCFRP_CPUE$affiliated_mpa <- tolower(CCFRP_CPUE$affiliated_mpa)

CCFRP_CPUE$affiliated_mpa <- recode_factor(CCFRP_CPUE$affiliated_mpa, "southeast farallon islands smr" = "southeast farallon island smr") #clean up names

CCFRP_CPUE$affiliated_mpa <- recode_factor(CCFRP_CPUE$affiliated_mpa, "swamis smr" = "swami's smca") #clean up names 


#add regions
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
four_region <- readxl::read_excel(file.path(data_path, input_file), sheet=1, skip = 0, na="NA")

regions <- four_region %>%
  dplyr::select(name, region3=bioregion, region4 = four_region_north_ci)

CCFRP_CPUE <- left_join(CCFRP_CPUE, regions, by=c("affiliated_mpa"="name"))

#clean up a

CCFRP_CPUE <- CCFRP_CPUE %>%
  mutate(MHW = ifelse(year>=2014 & year<=2016, "during",ifelse(year<2014, "before","after")))%>%
  dplyr::select(year, group, region3, region4, MHW, everything())

#Export
#path_aurora <- "/home/shares/ca-mpa/data/sync-data/processed_data/ecological_community_data" 
#write.csv(CCFRP_CPUE,file.path(path_aurora, "CCFRP_species_counts.csv"), row.names = FALSE)


```





#Process kelp forest fish data

```{r}

data_path <- "/home/shares/ca-mpa/data/sync-data/monitoring/monitoring_kelp"
input_file <- "MLPA_kelpforest_fish.4.csv" 
kelp_fish_counts <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names()

#select vars and clean
kelp_fish_counts <- kelp_fish_counts %>%
                    dplyr::select(year, site, zone, level, transect, classcode, count)%>%
                    group_by(year, site, zone, level, transect, classcode)%>%
                    summarize(total_count = sum(count)) #counts in raw data are grouped by size class. Take summary across all sizes


#join species names by class code 
input_file <- "MLPA_kelpforest_taxon_table.4.csv"  
kelp_taxon <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names() %>%
                    dplyr::select(classcode, species_definition) %>%
                    distinct() #remove duplicates

kelp_fish_counts<-  left_join(kelp_fish_counts, kelp_taxon, by="classcode")

kelp_fish_counts <- kelp_fish_counts %>%
                    dplyr::select(year, site, zone, level, transect, species=species_definition, total_count)
        

#add affiliated_mpa

input_file <- "MLPA_kelpforest_site_table.4.csv" 
kelp_sites <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names() %>%
                    dplyr::select(site, ca_mpa_name_short, mpa_class=site_designation, mpa_designation=site_status)%>%
                    distinct() #remove duplicates

kelp_fish_counts <- left_join(kelp_fish_counts, kelp_sites, by="site")

kelp_fish_counts <- kelp_fish_counts %>%
                    ungroup() %>%
                    dplyr::select(year, affiliated_mpa=ca_mpa_name_short,mpa_class, mpa_designation, zone, level, transect, species, total_count) %>%
                    mutate(mpa_designation = ifelse(mpa_designation=="reference","ref",mpa_class))


#add 4 regions
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
four_region <- readxl::read_excel(file.path(data_path, input_file), sheet=1, skip = 0, na="NA")

regions <- four_region %>%
  dplyr::select(name, region3=bioregion, region4 = four_region_north_ci)

kelp_fish_counts$affiliated_mpa <- tolower(kelp_fish_counts$affiliated_mpa)

kelp_fish_counts <- left_join(kelp_fish_counts, regions, by=c("affiliated_mpa"="name"))


#add defacto SMRs
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
defacto_smr <- readxl::read_excel(file.path(data_path, input_file), sheet=5, skip = 0, na="NA")%>%
               filter(group=="kelp") %>%
               dplyr::select(affiliated_mpa, mpa_class)
              

kelp_fish_counts <- left_join(kelp_fish_counts, defacto_smr, by="affiliated_mpa")


#clean up
kelp_fish_counts <- kelp_fish_counts %>%
                    mutate(mpa_defacto_designation = ifelse(mpa_designation=="ref","ref",mpa_class.y))%>%
                    dplyr::select(year, region3, region4, affiliated_mpa, mpa_defacto_class = mpa_class.y, mpa_defacto_designation, zone, level, transect, species, total_count)
                 
kelp_fish_counts$mpa_defacto_class <- tolower(kelp_fish_counts$mpa_defacto_class)
kelp_fish_counts$mpa_defacto_designation <- tolower(kelp_fish_counts$mpa_defacto_designation)

kelp_fish_counts <- kelp_fish_counts %>%
                    group_by(year, region3, region4, affiliated_mpa, mpa_defacto_class, mpa_defacto_designation, zone, level, transect, species) %>%
                    summarise(counts = sum(total_count)) #make sure species are not duplicates by summarizing at the transect level (total counts)




#reshape to wide format
kelp_fish_counts <- kelp_fish_counts %>%
                    pivot_wider(names_from=species, values_from=counts, values_fill = 0) %>%
                    janitor::clean_names()%>%
                    drop_na(region4)%>%
                    mutate(MHW = ifelse(year>=2014 & year<=2016, "during",ifelse(year<2014, "before","after")))%>%
                    dplyr::select(year, region3, region4, affiliated_mpa, mpa_defacto_class, mpa_defacto_designation, MHW, zone, level, transect, everything(),-c(no_organisms_present_in_this_sample))

#Export
#path_aurora <- "/home/shares/ca-mpa/data/sync-data/processed_data/ecological_community_data" 
#write.csv(kelp_fish_counts,file.path(path_aurora, "kelp_fish_counts.csv"), row.names = FALSE)


```




#Process kelp swath data
```{r}
data_path <- "/home/shares/ca-mpa/data/sync-data/monitoring/monitoring_kelp"
input_file <- "MLPA_kelpforest_swath.4.csv" 
kelp_swath_counts <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names()


#select vars and clean
kelp_swath_counts <- kelp_swath_counts %>%
                    dplyr::select(year, site, zone, transect, classcode, count)%>%
                    group_by(year, site, zone, transect, classcode)%>%
                    summarize(total_count = sum(count)) #counts in raw data are grouped by size class. Take summary across all sizes

#join species names by class code 
input_file <- "MLPA_kelpforest_taxon_table.4.csv"  
kelp_taxon <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names() %>%
                    dplyr::select(classcode, species_definition) %>%
                    distinct() #remove duplicates

kelp_swath_counts<-  left_join(kelp_swath_counts, kelp_taxon, by="classcode")

kelp_swath_counts <- kelp_swath_counts %>%
                    dplyr::select(year, site, zone, transect, species=species_definition, total_count)


#add affiliated_mpa

input_file <- "MLPA_kelpforest_site_table.4.csv" 
kelp_sites <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names() %>%
                    dplyr::select(site, ca_mpa_name_short, mpa_class=site_designation, mpa_designation=site_status)%>%
                    distinct() #remove duplicates

kelp_swath_counts <- left_join(kelp_swath_counts, kelp_sites, by="site")

kelp_swath_counts <- kelp_swath_counts %>%
                    ungroup() %>%
                    dplyr::select(year, affiliated_mpa=ca_mpa_name_short,mpa_class, mpa_designation, zone, transect, species, total_count) %>%
                    mutate(mpa_designation = ifelse(mpa_designation=="reference","ref",mpa_class))

#add 4 regions
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
four_region <- readxl::read_excel(file.path(data_path, input_file), sheet=1, skip = 0, na="NA")

regions <- four_region %>%
  dplyr::select(name, region3=bioregion, region4 = four_region_north_ci)

kelp_swath_counts$affiliated_mpa <- tolower(kelp_swath_counts$affiliated_mpa)

kelp_swath_counts <- left_join(kelp_swath_counts, regions, by=c("affiliated_mpa"="name"))



#add defacto SMRs
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
defacto_smr <- readxl::read_excel(file.path(data_path, input_file), sheet=5, skip = 0, na="NA")%>%
               filter(group=="kelp") %>%
               dplyr::select(affiliated_mpa, mpa_class)
              

kelp_swath_counts <- left_join(kelp_swath_counts, defacto_smr, by="affiliated_mpa")


#clean up
kelp_swath_counts <- kelp_swath_counts %>%
                    mutate(mpa_defacto_designation = ifelse(mpa_designation=="ref","ref",mpa_class.y))%>%
                    dplyr::select(year, region3, region4, affiliated_mpa, mpa_defacto_class = mpa_class.y, mpa_defacto_designation, zone, transect, species, total_count)
                 
kelp_swath_counts$mpa_defacto_class <- tolower(kelp_swath_counts$mpa_defacto_class)
kelp_swath_counts$mpa_defacto_designation <- tolower(kelp_swath_counts$mpa_defacto_designation)

kelp_swath_counts <- kelp_swath_counts %>%
                    group_by(year, region3, region4, affiliated_mpa, mpa_defacto_class, mpa_defacto_designation, zone, transect, species) %>%
                    summarise(counts = sum(total_count)) #make sure species are not duplicates by summarizing at the transect level (total counts)



#reshape to wide format
kelp_swath_counts <- kelp_swath_counts %>%
                    pivot_wider(names_from=species, values_from=counts, values_fill = 0) %>%
                    janitor::clean_names()%>%
                    drop_na(region4) %>%
                    mutate(MHW = ifelse(year>=2014 & year<=2016, "during",ifelse(year<2014, "before","after")))%>%
                    dplyr::select(year, region3, region4, affiliated_mpa, mpa_defacto_class, MHW, zone, transect, everything())
                    #dplyr::select(-c(no_organisms_present_in_this_sample))

#Export
#path_aurora <- "/home/shares/ca-mpa/data/sync-data/processed_data/ecological_community_data" 
#write.csv(kelp_swath_counts,file.path(path_aurora, "kelp_swath_counts.csv"), row.names = FALSE)


```


#process kelp forest upc data
```{r}
data_path <- "/home/shares/ca-mpa/data/sync-data/monitoring/monitoring_kelp"
input_file <- "MLPA_kelpforest_upc.4.csv" 
kelp_upc_counts <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names()


#select vars and clean
kelp_upc_counts <- kelp_upc_counts %>%
                    filter(category=="COVER")%>%
                    dplyr::select(year, site, zone, transect, classcode, count)%>%
                    group_by(year, site, zone, transect, classcode)%>%
                    summarize(total_count = sum(count)) #counts in raw data are grouped by size class. Take summary across all sizes


#join species names by class code 
input_file <- "MLPA_kelpforest_taxon_table.4.csv"  
kelp_taxon <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names() %>%
                    dplyr::select(classcode, species_definition) %>%
                    distinct() #remove duplicates

kelp_upc_counts<-  left_join(kelp_upc_counts, kelp_taxon, by="classcode")

kelp_upc_counts <- kelp_upc_counts %>%
                    dplyr::select(year, site, zone, transect, species=species_definition, total_count)


#add affiliated_mpa

input_file <- "MLPA_kelpforest_site_table.4.csv" 
kelp_sites <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names() %>%
                    dplyr::select(site, ca_mpa_name_short, mpa_class=site_designation, mpa_designation=site_status)%>%
                    distinct() #remove duplicates

kelp_upc_counts <- left_join(kelp_upc_counts, kelp_sites, by="site")

kelp_upc_counts <- kelp_upc_counts %>%
                    ungroup() %>%
                    dplyr::select(year, affiliated_mpa=ca_mpa_name_short,mpa_class, mpa_designation, zone, transect, species, total_count) %>%
                    mutate(mpa_designation = ifelse(mpa_designation=="reference","ref",mpa_class))



#add 4 regions
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
four_region <- readxl::read_excel(file.path(data_path, input_file), sheet=1, skip = 0, na="NA")

regions <- four_region %>%
  dplyr::select(name, region3=bioregion, region4 = four_region_north_ci)

kelp_upc_counts$affiliated_mpa <- tolower(kelp_upc_counts$affiliated_mpa)

kelp_upc_counts <- left_join(kelp_upc_counts, regions, by=c("affiliated_mpa"="name"))


#add defacto SMRs
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
defacto_smr <- readxl::read_excel(file.path(data_path, input_file), sheet=5, skip = 0, na="NA")%>%
               filter(group=="kelp") %>%
               dplyr::select(affiliated_mpa, mpa_class)
              

kelp_upc_counts <- left_join(kelp_upc_counts, defacto_smr, by="affiliated_mpa")


#clean up
kelp_upc_counts <- kelp_upc_counts %>%
                    mutate(mpa_defacto_designation = ifelse(mpa_designation=="ref","ref",mpa_class.y))%>%
                    dplyr::select(year, region3, region4, affiliated_mpa, mpa_defacto_class = mpa_class.y, mpa_defacto_designation, zone, transect, species, total_count)
                 
kelp_upc_counts$mpa_defacto_class <- tolower(kelp_upc_counts$mpa_defacto_class)
kelp_upc_counts$mpa_defacto_designation <- tolower(kelp_upc_counts$mpa_defacto_designation)

kelp_upc_counts <- kelp_upc_counts %>%
                    group_by(year, region3, region4, affiliated_mpa, mpa_defacto_class, mpa_defacto_designation, zone, transect, species) %>%
                    summarise(counts = sum(total_count)) #make sure species are not duplicates by summarizing at the transect level (total counts)



#reshape to wide format
kelp_upc_counts <- kelp_upc_counts %>%
                    pivot_wider(names_from=species, values_from=counts, values_fill = 0) %>%
                    janitor::clean_names()%>%
                    drop_na(region4) %>%
                    mutate(MHW = ifelse(year>=2014 & year<=2016, "during",ifelse(year<2014, "before","after")))%>%
                    dplyr::select(year, region3, region4, affiliated_mpa, mpa_defacto_class, MHW, zone, transect, everything())
                    #dplyr::select(-c(no_organisms_present_in_this_sample))

#Export
#path_aurora <- "/home/shares/ca-mpa/data/sync-data/processed_data/ecological_community_data" 
#write.csv(kelp_upc_counts,file.path(path_aurora, "kelp_upc_counts.csv"), row.names = FALSE)




```


#process midwater/deep reef data
```{r}
#load species level mean fish biomass 
data_path <- "/home/shares/ca-mpa/data/sync-data/monitoring/monitoring_deep-reef/ROV_Dataset"
input_file <- "MidDepth_ROV_Fish_Count.csv" 
deep_reef_counts_raw <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names()


#select vars and clean
deep_reef_counts <- deep_reef_counts_raw %>%
                    filter(!grepl('Unidentified',scientific_name), #remove anything not identified to the species level
                           !grepl('SMCA/Outside',type), #remove uncertain MPA types
                           !grepl('SMR/SMCA',type))%>%  #remove undertain MPA types
                    dplyr::select(year, mpa_group, type, designation, scientific_name, count)%>%
                    group_by(year, mpa_group, type, designation, scientific_name)%>%
                    summarize(total_count = sum(count)) #counts in raw data are grouped by size class. Take summary across all sizes 

deep_reef_counts$mpa_group[deep_reef_counts$mpa_group == "N/A" ] <- NA     #replace missing data with NA and drop
deep_reef_counts <- deep_reef_counts %>%
                    drop_na(mpa_group)

deep_reef_counts$designation <- recode_factor(deep_reef_counts$designation, "MPA/Outside" = 'Reference')




#add affiliated_mpa
deep_reef_counts <- deep_reef_counts %>%
                    mutate(mpa_class = type,
                           affiliated_mpa = paste(mpa_group,type),
                           mpa_designation = ifelse(designation=='Reference','ref',type))%>%
                    ungroup()%>%
                    dplyr::select(year, affiliated_mpa, mpa_class, mpa_designation, scientific_name, total_count)
                    
deep_reef_counts$affiliated_mpa <- tolower(deep_reef_counts$affiliated_mpa)


#check for inconsistencies in mpa name spelling and correct designations

deep_reef_counts$affiliated_mpa <- recode_factor(deep_reef_counts$affiliated_mpa, "se farallon islands smca" = "southeast farallon island smca") #correct spelling to match affiliated
deep_reef_counts$affiliated_mpa <- recode_factor(deep_reef_counts$affiliated_mpa, "se farallon islands smr" = "southeast farallon island smr") #correct spelling to match affiliated
deep_reef_counts$affiliated_mpa <- recode_factor(deep_reef_counts$affiliated_mpa, "n farallon islands smr" = "north farallon island smr") #correct spelling to match affiliated
deep_reef_counts$affiliated_mpa <- recode_factor(deep_reef_counts$affiliated_mpa, "n farallon islands smca" = "north farallon island smr") #correct spelling to match affiliated
deep_reef_counts$affiliated_mpa <- recode_factor(deep_reef_counts$affiliated_mpa, "north farallon island smr" = "north farallon islands smr") #correct spelling to match affiliated

deep_reef_counts$affiliated_mpa <- recode_factor(deep_reef_counts$affiliated_mpa, "farallon islands smr" = "southeast farallon island smr") #correct spelling to match affiliated
deep_reef_counts$affiliated_mpa <- recode_factor(deep_reef_counts$affiliated_mpa, "farallon islands smca" = "southeast farallon island smr") #correct spelling to match affiliated
deep_reef_counts$affiliated_mpa <- recode_factor(deep_reef_counts$affiliated_mpa, "farnsworth smca" = "farnsworth offshore smca") #correct spelling to match affiliated
deep_reef_counts$affiliated_mpa <- recode_factor(deep_reef_counts$affiliated_mpa, "point st. george smca" = "point st. george reef offshore smca") #correct spelling to match affiliated
deep_reef_counts$affiliated_mpa <- recode_factor(deep_reef_counts$affiliated_mpa, "point buchon smr" = "Point Buchon") #correct spelling to match affiliated



#add defacto SMRs
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
defacto_smr <- readxl::read_excel(file.path(data_path, input_file), sheet=5, skip = 0, na="NA")%>%
               filter(group=="deep_reef") %>%
               dplyr::select(affiliated_mpa, mpa_class)

buchon_row <- c("Point Buchon","SMR","point buchon smr","No take.","deep_reef","SMR") 
defacto_smr <- rbind(defacto_smr,buchon_row) #add missing row
              
deep_reef_counts <- left_join(deep_reef_counts, defacto_smr, by="affiliated_mpa")


#clean
deep_reef_counts <- deep_reef_counts %>%
                    mutate(mpa_defacto_designation = ifelse(mpa_designation=='ref',mpa_designation,mpa_class.y))%>%
                    dplyr::select(year, affiliated_mpa, mpa_defacto_class=mpa_class.y, mpa_defacto_designation=mpa_designation, scientific_name, total_count)

deep_reef_counts$scientific_name[deep_reef_counts$scientific_name == "" ] <- NA     #replace missing data with NA and drop

deep_reef_counts <- deep_reef_counts %>%
                    drop_na(scientific_name)

deep_reef_counts$mpa_defacto_class <- tolower(deep_reef_counts$mpa_defacto_class)
deep_reef_counts$mpa_defacto_designation <- tolower(deep_reef_counts$mpa_defacto_designation)


#add 4 regions
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
four_region <- readxl::read_excel(file.path(data_path, input_file), sheet=1, skip = 0, na="NA")

regions <- four_region %>%
  dplyr::select(name, region3=bioregion, region4 = four_region_north_ci)

deep_reef_counts$affiliated_mpa <- recode_factor(deep_reef_counts$affiliated_mpa, "Point Buchon"="point buchon smr")

deep_reef_counts <- left_join(deep_reef_counts, regions, by=c("affiliated_mpa"="name"))

#clean
deep_reef_counts <- deep_reef_counts %>%
                    group_by(year, region3, region4, affiliated_mpa, mpa_defacto_class, mpa_defacto_designation, scientific_name) %>%
                    summarise(counts = sum(total_count)) #make sure species are not duplicates by summarizing at the transect level (total counts)


#reshape to wide format
deep_reef_counts_wide <- deep_reef_counts %>%
                    pivot_wider(names_from=scientific_name, values_from=counts) %>%
                    janitor::clean_names()%>%
                    drop_na(region4) %>%
                    mutate(MHW = ifelse(year>=2014 & year<=2016, "during",ifelse(year<2014, "before","after")))%>%
                    dplyr::select(year, region3, region4, affiliated_mpa, mpa_defacto_class,mpa_defacto_designation, MHW, everything()) %>%
                    replace(is.na(.),0)
                    #dplyr::select(-c(no_organisms_present_in_this_sample))

#Export
#path_aurora <- "/home/shares/ca-mpa/data/sync-data/processed_data/ecological_community_data" 
#write.csv(deep_reef_counts_wide,file.path(path_aurora, "deep_reef_fish_counts.csv"), row.names = FALSE)


```


#process intertidal data
```{r}
#load species level mean fish biomass 
data_path <- "/home/shares/ca-mpa/data/sync-data/monitoring/monitoring_rocky-intertidal/Biodiversity surveys"
input_file <- "swath_summary_counts_2021_0108.csv" 
rocky_counts_raw <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names()


```





















