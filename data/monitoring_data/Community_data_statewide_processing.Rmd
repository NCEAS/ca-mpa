---
title: "Community_data_statewide_processing"
author: "Joshua G. Smith"
date: "2022-12-13"
output: html_document
---

Statewide community data for kelp forest fishes, kelp forest inverts and algae
(combined), and rocky intertidal

#clear workspace and load packages
```{r}

rm(list = ls())

require(dplyr)
require(stringr)
require(tidyr)
require(janitor)
require(vegan)
```

#load environmental data
```{r}

#load data and get mpa-year level means
envr_dat <- readRDS("/home/shares/ca-mpa/data/sync-data/environmental/processed/envr_anomalies_at_mpas.Rds") %>%
            group_by(group, mpa_name, mpa_class, mpa_designation, mpa_defacto_class, mpa_defacto_designation,
                     region3, region4, year)%>%
            dplyr::summarise(across(c("sst_annual_baseline", "sst_monthly_baseline", "sst_annual_obs", "sst_monthly_obs", "sst_monthly_anom",       
            "cuti_annual_baseline", "cuti_monthly_baseline", "cuti_annual_obs", "cuti_monthly_obs", "cuti_monthly_anom",     
            "beuti_annual_baseline", "beuti_monthly_baseline", "beuti_annual_obs", "beuti_monthly_obs", "beuti_monthly_anom",     
              "annual_MOCI"), ~ mean(.x, na.rm = TRUE)))

rocky_envr_vars <- readRDS("/home/shares/ca-mpa/data/sync-data/environmental/processed/envr_anomalies_at_intertidal_mpas.Rds")

```


**Step 1 - process ecological data in species counts / year format**

#Process kelp forest fish data

```{r}

data_path <- "/home/shares/ca-mpa/data/sync-data/monitoring/monitoring_kelp"
input_file <- "MLPA_kelpforest_fish.4.csv" 
kelp_fish_counts <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names()

#select vars and clean
kelp_fish_counts <- kelp_fish_counts %>%
                    dplyr::select(year, site, zone, level, transect, classcode, count)%>%
                    group_by(year, site, zone, level, transect, classcode)%>%
                    dplyr::summarize(total_count = sum(count)) #counts in raw data are grouped by size class. Take summary across all sizes

#join species names by class code 
input_file <- "MLPA_kelpforest_taxon_table.4.csv"  
kelp_taxon <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names() %>%
                    dplyr::select(classcode, species_definition) %>%
                    distinct() #remove duplicates

kelp_fish_counts<-  left_join(kelp_fish_counts, kelp_taxon, by="classcode")

kelp_fish_counts <- kelp_fish_counts %>%
                    dplyr::select(year, site, zone, level, transect, species=species_definition, total_count)%>%
                    filter(!(species=='Sebastes atrovirens/carnatus/chrysomelas/caurinus'))


#add affiliated_mpa

input_file <- "MLPA_kelpforest_site_table.4.csv" 
kelp_sites <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names() %>%
                    dplyr::select(site, ca_mpa_name_short, mpa_class=site_designation, mpa_designation=site_status)%>%
                    distinct() #remove duplicates

kelp_fish_counts <- left_join(kelp_fish_counts, kelp_sites, by="site")

kelp_fish_counts <- kelp_fish_counts %>%
                    ungroup() %>%
                    dplyr::select(year, affiliated_mpa=ca_mpa_name_short,mpa_class, mpa_designation, zone, level, transect, species,
                                  total_count) %>%
                    mutate(mpa_designation = ifelse(mpa_designation=="reference","ref",mpa_class))


#add 4 regions
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
four_region <- readxl::read_excel(file.path(data_path, input_file), sheet=1, skip = 0, na="NA")

regions <- four_region %>%
  dplyr::select(name, region3=bioregion, region4 = four_region_north_ci)

kelp_fish_counts$affiliated_mpa <- tolower(kelp_fish_counts$affiliated_mpa)

kelp_fish_counts <- left_join(kelp_fish_counts, regions, by=c("affiliated_mpa"="name"))


#add defacto SMRs
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
defacto_smr <- readxl::read_excel(file.path(data_path, input_file), sheet=5, skip = 0, na="NA")%>%
               filter(group=="kelp") %>%
               dplyr::select(affiliated_mpa, mpa_class)
              

kelp_fish_counts <- left_join(kelp_fish_counts, defacto_smr, by="affiliated_mpa")


#clean up
kelp_fish_counts <- kelp_fish_counts %>%
                    mutate(mpa_defacto_designation = ifelse(mpa_designation=="ref","ref",mpa_class.y))%>%
                    dplyr::select(year, region3, region4, affiliated_mpa, mpa_defacto_class = mpa_class.y, mpa_defacto_designation, zone, level, transect, species, total_count)
                 
kelp_fish_counts$mpa_defacto_class <- tolower(kelp_fish_counts$mpa_defacto_class)
kelp_fish_counts$mpa_defacto_designation <- tolower(kelp_fish_counts$mpa_defacto_designation)

kelp_fish_counts <- kelp_fish_counts %>%
                    group_by(year, region3, region4, affiliated_mpa, mpa_defacto_class, mpa_defacto_designation, zone, level, transect, species) %>%
                    dplyr::summarise(counts = sum(total_count)) #make sure species are not duplicates by summarizing at the transect level (total counts)




#reshape to wide format
kelp_fish_counts1 <- kelp_fish_counts %>%
                    pivot_wider(names_from=species, values_from=counts, values_fill = 0) %>%
                    janitor::clean_names()%>%
                    drop_na(region4)%>%
                    mutate(MHW = ifelse(year>=2014 & year<=2016, "during",ifelse(year<2014, "before","after")))%>%
                    dplyr::select(year, region3, region4, affiliated_mpa, mpa_defacto_class, mpa_defacto_designation, MHW, zone, level, transect, everything(),-c(no_organisms_present_in_this_sample))


#drop species and combine to higher taxa
#### see reference taxonomy table https://docs.google.com/spreadsheets/d/1vxy0XVOrlNhXD-i9tWL_F9G5h8S3S4OV/edit#gid=2031917236

kelp_fish_combined <- as.data.frame(kelp_fish_counts1) %>%
                  
                  #merge species
                  dplyr::mutate(citharichthys_merge = rowSums(select(.,'citharichthys','citharichthys_sordidus','citharichthys_stigmaeus')
                                                              ))%>%
                  select(!(c('citharichthys','citharichthys_sordidus','citharichthys_stigmaeus'))) %>%
                  #drop species
                  select(!(
                           c('anisotremus_davidsonii',
                             'cheilotrema_saturnum',
                             'unidentified_fish',
                             'apodichthys_flavidus',
                             'atherinopsidae',
                             'aulorhynchus_flavidus',
                             'bothidae',
                             'clupeiformes',
                             'cryptacanthodes_giganteus',
                             'embiotocidae',
                             'engraulis_mordax',
                             'gobiesox_maeandricus',
                             'hyperprosopon_anale',
                             'hyperprosopon_argenteum',
                             'hyperprosopon_ellipticum',
                             'leiocottus_hirundo',
                             'lethops_connectens',
                             'neoclinus_blanchardi',
                             'pholidae',
                             'pleuronectidae',
                             'rathbunella_alleni',
                             'rathbunella_hypoplecta',
                             'ronquilus_jordani',
                             'sardinops_sagax',
                             'sebastes',
                             'stichaeidae',
                             'syngnathus',
                             'trachurus_symmetricus',
                             'ulvicola_sanctaerosae')))%>%
                  #drop string
                  rename(citharichthys=citharichthys_merge)
                         

#Export
#path_aurora <- "/home/shares/ca-mpa/data/sync-data/processed_data/ecological_community_data" 
#write.csv(kelp_fish_counts,file.path(path_aurora, "kelp_fish_counts.csv"), row.names = FALSE)


kelp_fish_mpa_year_step1 <- kelp_fish_combined %>% 
                  pivot_longer(cols=11:121, names_to="species",values_to="counts")%>%
                  group_by(year, region3, region4, affiliated_mpa, mpa_defacto_class, mpa_defacto_designation, MHW, species)%>%
                  dplyr::summarize(total_counts = sum(counts))%>%
                  ungroup()%>%
                  pivot_wider(names_from = "species", values_from = "total_counts") %>%
                  mutate(group = "kelp")

kelp_fish_mpa_year <- left_join(kelp_fish_mpa_year_step1, envr_dat, by=c("year","group",
                                                       "region3","region4",
                                                       "mpa_defacto_class",
                                                       "mpa_defacto_designation",
                                                       "affiliated_mpa"="mpa_name"))%>%
                  dplyr::select(1:7,119:137,8:118) %>%
                  dplyr::select(!c("mpa_class","mpa_designation")) %>%
                  mutate(group="kelp_fish") %>%
                  dplyr::select(group, everything()) %>%
                  #filter(region3 == 'central') %>%
                  select(where(~ any(. != 0)))


#Export year                     
#path_aurora <- "/home/shares/ca-mpa/data/sync-data/monitoring/processed_data/community_climate_derived_data" 
#write.csv(kelp_fish_mpa_year,file.path(path_aurora, "kelp_fish_statewide.csv"), row.names = FALSE)
```


#Process kelp swath data
```{r}
data_path <- "/home/shares/ca-mpa/data/sync-data/monitoring/monitoring_kelp"
input_file <- "MLPA_kelpforest_swath.4.csv" 
kelp_swath_counts <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names()


#select vars and clean
kelp_swath_counts <- kelp_swath_counts %>%
                    dplyr::select(year, site, zone, transect, classcode, count)%>%
                    group_by(year, site, zone, transect, classcode)%>%
                    dplyr::summarize(total_count = sum(count)) #counts in raw data are grouped by size class. Take summary across all sizes

#join species names by class code 
input_file <- "MLPA_kelpforest_taxon_table.4.csv"  
kelp_taxon <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names() %>%
                    dplyr::select(classcode, species_definition) %>%
                    distinct() #remove duplicates

kelp_swath_counts<-  left_join(kelp_swath_counts, kelp_taxon, by="classcode")

kelp_swath_counts <- kelp_swath_counts %>%
                    dplyr::select(year, site, zone, transect, species=species_definition, total_count)


#add affiliated_mpa

input_file <- "MLPA_kelpforest_site_table.4.csv" 
kelp_sites <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names() %>%
                    dplyr::select(site, ca_mpa_name_short, mpa_class=site_designation, mpa_designation=site_status)%>%
                    distinct() #remove duplicates

kelp_swath_counts <- left_join(kelp_swath_counts, kelp_sites, by="site")

kelp_swath_counts <- kelp_swath_counts %>%
                    ungroup() %>%
                    dplyr::select(year, affiliated_mpa=ca_mpa_name_short,mpa_class, mpa_designation, zone, transect, species, total_count) %>%
                    mutate(mpa_designation = ifelse(mpa_designation=="reference","ref",mpa_class))

#add 4 regions
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
four_region <- readxl::read_excel(file.path(data_path, input_file), sheet=1, skip = 0, na="NA")

regions <- four_region %>%
  dplyr::select(name, region3=bioregion, region4 = four_region_north_ci)

kelp_swath_counts$affiliated_mpa <- tolower(kelp_swath_counts$affiliated_mpa)

kelp_swath_counts <- left_join(kelp_swath_counts, regions, by=c("affiliated_mpa"="name"))



#add defacto SMRs
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
defacto_smr <- readxl::read_excel(file.path(data_path, input_file), sheet=5, skip = 0, na="NA")%>%
               filter(group=="kelp") %>%
               dplyr::select(affiliated_mpa, mpa_class)
              

kelp_swath_counts <- left_join(kelp_swath_counts, defacto_smr, by="affiliated_mpa")


#clean up
kelp_swath_counts <- kelp_swath_counts %>%
                    mutate(mpa_defacto_designation = ifelse(mpa_designation=="ref","ref",mpa_class.y))%>%
                    dplyr::select(year, region3, region4, affiliated_mpa, mpa_defacto_class = mpa_class.y, mpa_defacto_designation, zone, transect, species, total_count)
                 
kelp_swath_counts$mpa_defacto_class <- tolower(kelp_swath_counts$mpa_defacto_class)
kelp_swath_counts$mpa_defacto_designation <- tolower(kelp_swath_counts$mpa_defacto_designation)

kelp_swath_counts <- kelp_swath_counts %>%
                    group_by(year, region3, region4, affiliated_mpa, mpa_defacto_class, mpa_defacto_designation, zone, transect, species) %>%
                    dplyr::summarize(counts = sum(total_count)) #make sure species are not duplicates by summarizing at the transect level (total counts)


#Run this code to aggregate at MPA-year level
#kelp_swath_mpa_year <- kelp_swath_counts %>%
#                    group_by(year, region3, region4, affiliated_mpa, mpa_defacto_class, mpa_defacto_designation, species) %>%
#                    dplyr::summarize(counts = sum(counts)) 


#reshape to wide format
kelp_swath_counts1 <- kelp_swath_counts %>%
                    pivot_wider(names_from=species, values_from=counts, values_fill = 0) %>%
                    janitor::clean_names()%>%
                    drop_na(region4) %>%
                    mutate(MHW = ifelse(year>=2014 & year<=2016, "during",ifelse(year<2014, "before","after")))%>%
                    dplyr::select(year, region3, region4, affiliated_mpa, mpa_defacto_class, MHW, everything())
                    #dplyr::select(-c(no_organisms_present_in_this_sample))



#drop species and combine to higher taxa
#### see reference taxonomy table https://docs.google.com/spreadsheets/d/1vxy0XVOrlNhXD-i9tWL_F9G5h8S3S4OV/edit#gid=2031917236

kelp_swath_counts2 <- as.data.frame(kelp_swath_counts1) %>%
                  
                  #merge species
                  dplyr::mutate(urticina_merge = rowSums(select(.,'urticina', 
                                                          'urticina_coriacea', 'urticina_crassicornis', 'urticina_piscivora')
                                                              ))%>%
                  select(!(c('urticina', 
                                                          'urticina_coriacea', 'urticina_crassicornis', 'urticina_piscivora'))) %>%
                  #drop species
                  select(!(c('anthopleura',
                             'apostichopus',
                             'asteroidea',
                             'haliotis',
                             'laminaria',
                             'laminariales',
                             'octopus',
                             'pisaster',
                             'pugettia_spp',
                             'stylasterias_forreri',
                             'urticina_columbiana',
                             'urticina_columbiana_mcpeaki',
                             )))%>%
                  #drop string
                  rename(urticina=urticina_merge)


#drop species that were never observed 
kelp_swath_zero_drop <- kelp_swath_counts2 %>% #filter(region3=='central') %>%
                    select(!(where(~ any(. != 0))))

kelp_swath_counts3 <- kelp_swath_counts2 %>% #filter(region3=='central') %>%
                    select(where(~ any(. != 0)))

#Export
#path_aurora <- "/home/shares/ca-mpa/data/sync-data/processed_data/ecological_community_data" 
#write.csv(kelp_swath_mpa_year, file.path(path_aurora, "kelp_swath_mpa_year_counts.csv"), row.names = FALSE)

kelp_swath_mpa_year_step1 <- kelp_swath_counts3 %>%
                        pivot_longer(cols=10:72, names_to="species",values_to="counts")%>%
                        group_by(year, region3, region4, affiliated_mpa, mpa_defacto_class, mpa_defacto_designation, MHW, species)%>%
                        dplyr::summarize(total_counts = sum(counts))%>%
                        ungroup()%>%
                        pivot_wider(names_from = "species", values_from = "total_counts")%>%
                        mutate(group="kelp")


kelp_swath_mpa_year <- left_join(kelp_swath_mpa_year_step1, envr_dat, 
                                      by=c("year","group",
                                                       "region3","region4",
                                                       "mpa_defacto_class",
                                                       "mpa_defacto_designation",
                                                       "affiliated_mpa"="mpa_name"))%>%
                  dplyr::select(1:7,71:89,8:70) %>%
                  dplyr::select(!c("mpa_class","mpa_designation")) %>%
                  mutate(group = "kelp_swath")%>%
                  dplyr::select(group, everything()) %>%
                  #filter(region3 == 'central') %>%
                  select(where(~ any(. != 0)))


#Export year level
#path_aurora <- "/home/shares/ca-mpa/data/sync-data/monitoring/processed_data/community_climate_derived_data" 
#write.csv(kelp_swath_mpa_year, file.path(path_aurora, "kelp_swath_mpa_year.csv"), row.names = FALSE)

```


#process kelp forest upc data
```{r}
data_path <- "/home/shares/ca-mpa/data/sync-data/monitoring/monitoring_kelp"
input_file <- "MLPA_kelpforest_upc.4.csv" 
kelp_upc_counts <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names()%>%
                    filter(category=="COVER")


#select vars and clean
kelp_upc_counts1 <- kelp_upc_counts %>%
                    dplyr::select(year, site, zone, transect, classcode, count, pct_cov)%>%
                    group_by(year, site, zone, transect, classcode)


#join species names by class code 
input_file <- "MLPA_kelpforest_taxon_table.4.csv"  
kelp_taxon <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names() %>%
                    dplyr::select(classcode, species_definition) %>%
                    distinct() #remove duplicates

kelp_upc_counts2<-  left_join(kelp_upc_counts1, kelp_taxon, by="classcode")

kelp_upc_counts3 <- kelp_upc_counts2 %>%
                    dplyr::select(year, site, zone, transect, classcode, species=species_definition, count, pct_cov)

#drop data 
kelp_upc_counts4 <- kelp_upc_counts3 %>%
                    filter(!(species=="Haliotis"|
                               species=="Laminaria"|
                               species=="laminariales"|
                               species=="UCSC 2000 Definition Of 'Other Red' Included All Red Algae Except Rhospp, Bushy, Leafy, Crucor And Erecor"|
                               species=="UCSB 2000 Definition Of 'Other Red' Included All Red Algae Except Rhospp, Bushy, Leafy, Crucor And Erecor"|
                               species=="Red Alga With Cylindrical Branches. Definition Used In 2000"|
                              species=="UCSC and UCSB 1999 Definition Of 'Other Red' Included All Red Algae Except Rhospp, Crucor And Erecor"|
                               species=="Laminariales Holdfast (Alive)"|
                               species=="Sargassum"|
                               species=="Aglaophenia struthionides"|
                               species=="Macrosystis Holdfast (Dead)"|
                               species=="Bare Rock"|
                               species=="Bare Sand"|
                               species=="Unidentified Fish"|
                               species=="Actiniaria"|
                               species=="Shell Debris"|
                               species=="Sediment/Mud"|
                               species=="Stylantheca papillosa"|
                               species=="Diaperoforma californica"|
                               species==""))


#recalculate percent cov
kelp_upc_counts5 <- kelp_upc_counts4 %>%
                    group_by(year, site, zone, transect, classcode, species)%>%
                    dplyr::summarize(sum_count = sum(count)) 

#check to make sure UPC counts add up to ~30 per transect               
check_counts <- kelp_upc_counts4 %>%
                    group_by(year, site, zone, transect)%>%
                    dplyr::summarize(transect_total = sum(count))

#join percent cov with transect total
kelp_upc_counts6 <- left_join(kelp_upc_counts5, check_counts, by=c("year","site","zone","transect"))%>%
                    mutate(pct_cov = (sum_count / transect_total)*100)%>%
                    mutate_at(vars(pct_cov), round, 1)



#add affiliated_mpa

input_file <- "MLPA_kelpforest_site_table.4.csv" 
kelp_sites <- read.csv(file.path(data_path, input_file)) %>%
                    janitor::clean_names() %>%
                    dplyr::select(site, ca_mpa_name_short, mpa_class=site_designation, mpa_designation=site_status)%>%
                    distinct() #remove duplicates

kelp_upc_counts <- left_join(kelp_upc_counts6, kelp_sites, by="site")

kelp_upc_counts <- kelp_upc_counts %>%
                    ungroup() %>%
                    dplyr::select(year, affiliated_mpa=ca_mpa_name_short,mpa_class, mpa_designation, zone, transect, classcode, species, pct_cov) %>%
                    mutate(mpa_designation = ifelse(mpa_designation=="reference","ref",mpa_class))



#add 4 regions
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
four_region <- readxl::read_excel(file.path(data_path, input_file), sheet=1, skip = 0, na="NA")

regions <- four_region %>%
  dplyr::select(name, region3=bioregion, region4 = four_region_north_ci)

kelp_upc_counts$affiliated_mpa <- tolower(kelp_upc_counts$affiliated_mpa)

kelp_upc_counts <- left_join(kelp_upc_counts, regions, by=c("affiliated_mpa"="name"))


#add defacto SMRs
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
defacto_smr <- readxl::read_excel(file.path(data_path, input_file), sheet=5, skip = 0, na="NA")%>%
               filter(group=="kelp") %>%
               dplyr::select(affiliated_mpa, mpa_class)
              

kelp_upc_counts <- left_join(kelp_upc_counts, defacto_smr, by="affiliated_mpa")

#final check for any odd species

kelp_spp_check <- kelp_upc_counts #filter(region3=='central')
unique(kelp_spp_check$species)

#clean up
kelp_upc_counts <- kelp_upc_counts %>%
                    mutate(mpa_defacto_designation = ifelse(mpa_designation=="ref","ref",mpa_class.y))%>%
                    dplyr::select(year, region3, region4, affiliated_mpa, mpa_defacto_class = mpa_class.y, mpa_defacto_designation, zone, transect, 
                                  classcode, species, pct_cov)
                 
kelp_upc_counts$mpa_defacto_class <- tolower(kelp_upc_counts$mpa_defacto_class)
kelp_upc_counts$mpa_defacto_designation <- tolower(kelp_upc_counts$mpa_defacto_designation)

kelp_upc_counts <- kelp_upc_counts %>%
                    group_by(year, region3, region4, affiliated_mpa, mpa_defacto_class, mpa_defacto_designation, species) %>%
                    dplyr::summarise(mean_pct_cov = mean(pct_cov)) #take transect levels means



#reshape to wide format
kelp_upc_mpa_year_step1 <- kelp_upc_counts %>%
                    pivot_wider(names_from=species, values_from=mean_pct_cov) %>%
                    janitor::clean_names()%>%
                    drop_na(region4) %>%
                    mutate(MHW = ifelse(year>=2014 & year<=2016, "during",ifelse(year<2014, "before","after")))%>%
                    dplyr::select(year, region3, region4, affiliated_mpa, mpa_defacto_class, MHW, everything())%>%
                    mutate(group='kelp')
                    #dplyr::select(-c(no_organisms_present_in_this_sample))


kelp_upc_mpa_year <- left_join(kelp_upc_mpa_year_step1, envr_dat, 
                               by=c("year","group",
                                                       "region3","region4",
                                                       "mpa_defacto_class",
                                                       "mpa_defacto_designation",
                                                       "affiliated_mpa"="mpa_name"))%>%
                  dplyr::select(1:7,64:82,8:63) %>%
                  mutate(group="kelp_upc")%>%
                  dplyr::select(!c("mpa_class","mpa_designation")) %>%
                  dplyr::select(group, everything()) %>%
                  mutate_at(c(25:80), ~replace_na(.,0))%>%
                  #filter(region3 == 'central') %>%
                  select(where(~ any(. != 0)))

#Export
#path_aurora <- "/home/shares/ca-mpa/data/sync-data/monitoring/processed_data/community_climate_derived_data" 
#write.csv(kelp_upc_mpa_year,file.path(path_aurora, "kelp_upc_mpa_year.csv"), row.names = FALSE)


```

#Standardize and merge kelp swath and UPC data
```{r}

require(vegan)

#standardize swath to max
kelp_swath_stan <- decostand(kelp_swath_mpa_year[25:87], method="max",
                             margin=2, na.rm=TRUE)

nrow(kelp_swath_mpa_year) #check length
nrow(kelp_swath_stan) #check length

kelp_swath_stan1 <- cbind(kelp_swath_mpa_year[1:24],kelp_swath_stan)%>%
                    select(!c('dictyoneurum_californicum_reticulatum')) #drop this spp because UPC counts are more accurate


#standardize upc to max
kelp_upc_stan <- decostand(kelp_upc_mpa_year[25:80], method="max",
                             margin=2, na.rm=TRUE)

nrow(kelp_upc_mpa_year) #check length
nrow(kelp_upc_stan) #check length

kelp_upc_stan1 <- cbind(kelp_upc_mpa_year[1:24],kelp_upc_stan) %>%
                  select(!c('macrocystis_pyrifera',
                       'stylaster_californicus',
                       'stephanocystis_osmundacea')) #remove UPC species that are recorded by swath




#Join stan dat

kelp_upc_stan2 <- kelp_upc_stan1 %>%
                  select(!(9:24))

kelp_stan <- left_join(kelp_swath_stan1, kelp_upc_stan2, by=c("year",
                                                              "region3", "region4",
                                                              "affiliated_mpa",
                                                              "mpa_defacto_class",
                                                              "MHW",
                                                              "mpa_defacto_designation"))%>%
                        select(!(c(group.x, group.y)))%>%
                        mutate(group = "kelp_invalg")%>%
                        select(group, everything())
               

#check for any unmatched data
kelp_check <-  anti_join(kelp_swath_stan1, kelp_upc_stan2, by=c("year",
                                                              "region3", "region4",
                                                              "affiliated_mpa",
                                                              "mpa_defacto_class",
                                                              "MHW",
                                                              "mpa_defacto_designation"))


#path_aurora <- "/home/shares/ca-mpa/data/sync-data/monitoring/processed_data/community_climate_derived_data"
#write.csv(kelp_stan, file.path(path_aurora, "kelp_swath_upc_statewide.csv"), row.names = FALSE)
```


#process intertidal data
```{r}
#
#load intertidal 
data_path <- "/home/shares/ca-mpa/data/sync-data/monitoring/monitoring_rocky-intertidal/Community analysis"
input_file <- "intertidal_site_counts.csv"
  
rocky_counts_raw <- read.csv(file.path(data_path, input_file)) %>%
                                janitor::clean_names()


#clean
rocky_counts_raw$affiliated_mpa <- tolower(rocky_counts_raw$affiliated_mpa)

rocky_counts_raw$mpa_designation <- tolower(rocky_counts_raw$mpa_designation)

rocky_counts_raw$mpa_designation <- recode_factor(rocky_counts_raw$mpa_designation,"none"="ref")

rocky_counts_raw <- rocky_counts_raw %>%
                    filter(!(mpa_designation=='sc')) %>%
                     mutate(year = (as.factor(year)))

rocky_counts_raw$site <- tolower(rocky_counts_raw$site) 



rocky_count_envr <- left_join(rocky_counts_raw, rocky_envr_vars, by=c("year","site"))%>%
  mutate(group="rocky")%>%
  select(year, group, region3, region4,site, mpa_designation, affiliated_mpa, 
         mpa_designation,59:74, 8:56) %>%
        #filter(region3 == 'central') %>%
                  select(where(~ any(. != 0)))%>%
        select(!(c(rock, sand, tar))) %>% 
  mutate(row_sum = rowSums(.[24:68]))

#convert to proportion after substrate drop (rock sand tar)

rocky_count_prop <- rocky_count_envr %>%
                    rowwise() %>%
                    mutate(across(24:68)/row_sum)%>%
                    select(!(row_sum))


#export
#path_aurora <- "/home/shares/ca-mpa/data/sync-data/monitoring/processed_data/community_climate_derived_data" 
#write.csv(rocky_count_prop, file.path(path_aurora, "rocky_statewide.csv"), row.names = FALSE)

```




