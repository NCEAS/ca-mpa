---
title: "Community_trajectory"
author: "Joshua G. Smith"
date: '2022-06-16'
output: html_document
---
---
title: "Community_data_processing"
author: "Joshua G. Smith"
date: '2022-06-16'
output: html_document
---

#load packages
```{r}
require(dplyr)
require(stringr)
require(tidyr)
require(janitor)
require(vegan)
require(ggplot2)
```


#load CCFRP data

```{r}
# ccfrp -------------------------------------------------------------------

#load species level mean fish CPUE
data_path <- "/home/shares/ca-mpa/data/sync-data/monitoring/monitoring_ccfrp/CCFRP_derived_data_tables_DataONE"
input_file <- "CCFRP_derived_effort_table.csv" 
CPUE_raw <- read.csv(file.path(data_path, input_file))

#reshape and clean up
CCFRP_CPUE <- CPUE_raw %>%
  mutate(affiliated_mpa = paste(Area,"smr"), #all ccfrp MPAs are defacto SMRs per PI
         mpa_designation = ifelse(MPA_Status == "MPA","smr", MPA_Status))
  
CCFRP_CPUE$mpa_designation <- tolower(CCFRP_CPUE$mpa_designation)
CCFRP_CPUE$mpa_designation <- tolower(CCFRP_CPUE$mpa_designation)

CCFRP_CPUE <- CCFRP_CPUE %>%
                  dplyr::select(year=Year, affiliated_mpa, mpa_designation, Grid_Cell_ID, Common_Name, CPUE_catch_per_angler_hour)%>%
                  mutate(mpa_class="smr", 
                         group="ccfrp") %>%
                  group_by(group, year, affiliated_mpa, mpa_class, mpa_designation, Grid_Cell_ID, Common_Name)%>%
                  summarise(CPUE_mean = mean(CPUE_catch_per_angler_hour))%>%  #some species in the raw data have duplicate entries.
                  ungroup() %>%
                  tidyr::pivot_wider(names_from = Common_Name, 
                                     values_from = CPUE_mean,
                                     values_fill = 0.00000000) %>%
                  janitor::clean_names()
              
CCFRP_CPUE$affiliated_mpa <- tolower(CCFRP_CPUE$affiliated_mpa)

CCFRP_CPUE$affiliated_mpa <- recode_factor(CCFRP_CPUE$affiliated_mpa, "southeast farallon islands smr" = "southeast farallon island smr") #clean up names

CCFRP_CPUE$affiliated_mpa <- recode_factor(CCFRP_CPUE$affiliated_mpa, "swamis smr" = "swami's smca") #clean up names 


#add regions
data_path <- "/home/shares/ca-mpa/data/sync-data/mpa_traits"
input_file <- "mpa-attributes.xlsx" 
four_region <- readxl::read_excel(file.path(data_path, input_file), sheet=1, skip = 0, na="NA")

regions <- four_region %>%
  dplyr::select(name, region3=bioregion, region4 = four_region_north_ci)

CCFRP_CPUE <- left_join(CCFRP_CPUE, regions, by=c("affiliated_mpa"="name"))

#clean up a

CCFRP_CPUE <- CCFRP_CPUE %>%
  dplyr::select(year, group, region3, region4, everything())

```


#ordinate by region

```{r}

CCFRP_test <- CCFRP_CPUE %>%
              filter(region4 == 'north')

year <- as.numeric(CCFRP_test$year)


CCFRP_test <- CCFRP_test[,9:102]

CCFRP_relative <- decostand(CCFRP_test, method = "total")
              
distmat <- 
    vegdist(CCFRP_relative, method = "eucl")


ord <- metaMDS(distmat, distance="eucl")



plot(ord)
ordiellipse(ord, year)
ordispider(ord, year, label=F)



scrs <- scores(ord)

scrs <- cbind(as.data.frame(scrs), year) #to facilitate computing centroids, add group var

cent <- aggregate(cbind(NMDS1, NMDS2) ~ year, data = scrs, FUN = mean) #computes centroids

segs <- merge(scrs, setNames(cent, c('year','oNMDS1','oNMDS2')),
              by = 'year', sort=FALSE) #to draw the spider, we need to use geom_segment() which required coordinates to draw the segment from and to. Our 'to'
                                       # coordinates, the xend and yend aesthetics will be the centroids. So we need to replicate the group centroid for each
                                       # observation in the group. T




ggplot(scrs, aes(x = NMDS1, y=NMDS2, colour = year, group=1)) +
  #geom_segment(data = segs,
               #mapping = aes(xend = oNMDS1, yend = oNMDS2)) + #spiders
  geom_point(data = cent, size=5) +                           #centroids
  geom_path(data = cent, size = 0.5, aes(color=year))+           #line connecting groups (years)
  #geom_point() +                                              #sample scores
  #coord_fixed() +
  geom_text(data=cent, aes(label=year), position=position_jitter())+
  #xlim(-4.5,4.5)+
  #ylim(-0.45,0.65)+
  theme_classic() +
  theme(legend.position='none')


```



#test ordinate across regions
```{r}

CCFRP_test <- CCFRP_CPUE 

year <- as.numeric(CCFRP_test$year)
region <- CCFRP_test$region4
mpa_designation <- CCFRP_test$mpa_designation

CCFRP_test <- CCFRP_test[,9:102]

CCFRP_relative <- decostand(CCFRP_test, method = "total") #convert absolute abundance to relative abundance
              
distmat <- 
    vegdist(CCFRP_relative, method = "eucl") #generates a euclidean based distance matrix


ord <- metaMDS(distmat, distance="eucl") #ordinates the dist matrix



plot(ord)
ordiellipse(ord, year)
ordispider(ord, year, label=F)



scrs <- scores(ord)

scrs <- cbind(as.data.frame(scrs), year, region, mpa_designation) #to facilitate computing centroids, add group var
scrs$region <- factor(scrs$region, level = c("north","central","north islands","south")) #set order
scrs$mpa_designation <- factor(scrs$mpa_designation, level = c("smr","ref")) #set order


cent <- aggregate(cbind(NMDS1, NMDS2) ~ year+region+mpa_designation, data = scrs, FUN = mean) #computes centroids by year and region

segs <- merge(scrs, setNames(cent, c('year','oNMDS1','oNMDS2')),
              by = 'year', sort=FALSE) #to draw the spider, we need to use geom_segment() which required coordinates to draw the segment from and to. Our 'to'
                                       # coordinates, the xend and yend aesthetics will be the centroids. So we need to replicate the group centroid for each
                                       # observation in the group. T




ggplot(scrs, aes(x = NMDS1, y=NMDS2, shape = region, color = mpa_designation, group=region)) +
  #geom_segment(data = segs,
               #mapping = aes(xend = oNMDS1, yend = oNMDS2)) + #spiders
  geom_point(data = cent, size=5) +                           #centroids
  geom_path(data = cent, size = 0.5, #aes(color=year)
            )+           #line connecting groups (years)
  #geom_point() +                                              #sample scores
  #coord_fixed() +
  geom_text(data=cent, aes(label=year), position=position_jitter(width=0.02, height=0.01))+
  #xlim(-4.5,4.5)+
  #ylim(-0.45,0.65)+
  facet_wrap(~mpa_designation,
             labeller = labeller(mpa_designation =
                                   c("ref"="REF",
                                     "smr"="SMR")))+
  ggtitle("CCFRP assemblage structure over time")+
  theme(strip.text = element_text(size=18, face="bold"))+
  theme(plot.title = element_text(size=20, face="bold"))+
  theme(text = element_text(20))
  
  #theme(legend.position='none')


```




