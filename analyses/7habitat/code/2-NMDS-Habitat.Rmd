---
title: "Habitat Attributes - NMDS Approach"
author: "Cori Lopazanski"
date: '2022-06-25'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

## Set Up

```{r}
# Packages 
library(tidyverse)
library(vegan)

# Directories
base.dir <- "/Volumes/GoogleDrive-105151121202188525604/Shared drives/NCEAS MPA network assessment/MPA Network Assessment: Working Group Shared Folder/data/sync-data" # Cori Local
#base.dir <- "/home/shares/ca-mpa/data/sync-data/" # Aurora Base
att.dir <- here::here(base.dir, "mpa_traits", "processed")

# Read Attribute (Habitat) Data
att_raw <- read_csv(file.path(att.dir, "mpa_attributes_clean.csv"))

```

## Build Attribute Data

Select habitat variables from attribute data. 

```{r}
att_data <- att_raw %>% 
  # Combine predicted and mapped columns for 0-30m
  mutate(hard_substrate_0_30m_km2_comb = hard_substrate_predicted_0_30m_km2 + hard_substrate_mapped_0_30m_km2,
         soft_substrate_0_30m_km2_comb = soft_substrate_0_30m_km2 + soft_substrate_predicted_0_30m_km2) %>% 
  # Select variables for inclusion in NMDS
  select(name,
         region = four_region_north_ci,
         size_km2,
         sandy_beach_km,
         rocky_inter_km,
         max_kelp_canopy_cdfw_km2,
         hard_substrate_0_30m_km2_comb,
         hard_substrate_30_100m_km2,
         hard_substrate_100_200m_km2,
         hard_substrate_200_3000m_km2,
         soft_substrate_0_30m_km2_comb,
         soft_substrate_30_100m_km2,
         soft_substrate_100_200m_km2,
         soft_substrate_200_3000m_km2,
         submarine_canyon_0_30m_km2,
         submarine_canyon_30_100m_km2,
         submarine_canyon_100_200m_km2,
         submarine_canyon_200_3000m_km2,
         estuary_km2,
         surfgrass_km,
         eelgrass_km2,
         coastal_marsh_km2)

names(att_data)
```

## 1. metaMDS with all mpa attributes

```{r}
# Update rownames and drop NAs for NMDS
att_data_nmds <- att_data %>% 
  column_to_rownames("name") %>% 
  select(!region) %>% 
  drop_na()

# Create metadata df with name, region, class
att_nmds_meta <- att_raw %>% 
  select(name, region = four_region_north_ci, mpa_class) %>% 
  filter(name %in% rownames(att_data_nmds))

# NMDS for all habitats, all MPAs
mds <- metaMDS(att_data_nmds, distance = "euclidean", trymax = 999)
mds
stressplot(mds)
```

## 2. envfit for vectors

Determine the relative contribution of variables to the separation

```{r}
# Output of metaMDS and the original matrix
fit <- envfit(mds, att_data_nmds, perm = 999)

# Extract pvalues for each attribute
fit_pval <- fit$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("attribute") %>% 
  dplyr::rename("pvals" = ".")

# Extract coordinates for each attribute, only keep = 0.001
fit_att <- fit %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("attribute") %>% 
  full_join(., fit_pval, by = "attribute") %>% 
  filter(pvals == 0.001)%>% 
  mutate(label.att = c("size", "soft 30-100m", "soft 100-200m", "estuary", "marsh"))

# Plot dimensions with attributes
plot_df <- scores(mds, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>% 
  full_join(att_nmds_meta, by = "name")

ggplot(plot_df, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = region,
                 shape = region),
             size = 3, alpha = 0.8) +
  stat_ellipse(aes(color = region)) +
  geom_segment(data = fit_att, aes(x = 0, xend = NMDS1,
                                   y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  scale_x_continuous(limits = c(-0.45, 0.55))+
  geom_text(data = fit_att, aes(label = label.att)) +
  labs(title = "NMDS",
       color = "",
       shape = "") + theme_classic()
```

## 3. separate estuarine MPAs

### examine list

Examine which MPAs have estuarine characteristics

```{r}
estuaries <- att_data_nmds %>% 
  filter_at(vars(estuary_km2, coastal_marsh_km2), any_vars(. > 0)) %>% 
  filter_at(vars(max_kelp_canopy_cdfw_km2:submarine_canyon_200_3000m_km2), all_vars(. == 0)) %>% 
  rownames_to_column("name")

estuaries$name
```
### remove estuaries 

```{r}
att_noest <- att_data_nmds %>% 
  rownames_to_column("name") %>% 
  filter(!(name %in% estuaries$name)) %>% 
  column_to_rownames("name")

att_noest_meta <- att_nmds_meta %>% 
  filter(!(name %in% estuaries$name))
```


## 4. metaMDS with estuarine MPAs removed

```{r}
mds_noest <- metaMDS(att_noest, distance = "euclidean", trymax = 999)
mds_noest
stressplot(mds_noest)
```

## 5. envfit for vectors

determine relative contribution of variables to the separation

```{r}
# Output of metaMDS and the original matrix
fit_noest <- envfit(mds_noest, att_noest, perm = 999)

# Extract pvalues for each attribute
fit_pval_noest <- fit_noest$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("attribute") %>% 
  dplyr::rename("pvals" = ".")

# Extract coordinates for each attribute, only keep = 0.001
fit_att_noest <- fit_noest %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("attribute") %>% 
  full_join(., fit_pval_noest, by = "attribute") %>% 
  filter(pvals == 0.001)

# Plot
plot_df2 <- scores(mds_noest, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>% 
  full_join(att_noest_meta, by = "name")

ggplot(plot_df2, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = region,
                 shape = region),
             size = 3, alpha = 0.8) +
  stat_ellipse(aes(color = region)) +
  geom_segment(data = fit_att_noest, aes(x = 0, xend = NMDS1,
                                   y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = fit_att_noest, aes(label = attribute)) +
   labs(title = "NMDS MPA Attributes - Estuarine MPAs Removed",
       color = "",
       shape = "") + theme_classic()
```


## 6. test for regional differences 

### permutest

test for differences in dispersion 

```{r}
# Distance Matrix
dismat <- vegdist(att_noest, method = "euclidean")

# disper
disper <- betadisper(dismat, type = "centroid", group = att_noest_meta$region)
plot(disper)

# Test for differences in dispersion for the regions
test <- permutest(disper)
test
```

### permanova

test for differences among regions

```{r}
# Difference among groups (regions)
permanova <- adonis2(formula = dismat ~ region, 
                     mwrhos = "euclidean",
                    data = att_noest_meta)

permanova

hsd <- TukeyHSD(disper)
hsd

```
