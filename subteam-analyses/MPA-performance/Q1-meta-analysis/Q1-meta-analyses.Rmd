---
title: "CA MPA Performance Q1 meta analyses"
author: "Joshua G. Smith"
date: "3/30/2022"
output: html_document:
  toc:yes
  pdf_document:
    highlight: tango
    toc: yes
    toc_depth: 6
---

**required packages**
```{r load_libraries, message=FALSE}
library(ggplot2)
library(metafor)
library(forestplot)
library(dplyr)
library(tidyr)
library(reshape2)
```

Import and initialize data
**replace with actual data**
```{r}
setwd("/home/joshsmith/MPA Project data")
test.data <- read.csv("Q1_test_data.csv")
head(test.data)
```


Calculate means for each variable and indicator at the state and regional level
```{r}
#calculate state level means 
test.data$mpa_designation<- recode_factor(test.data$mpa_designation,SMCA="MPA",SMR="MPA") ###========consider "SMCA" and "SMR" as "MPA"========##
state.means<- test.data%>% 
              group_by(group,mpa_designation,variable,indicator)%>%
              summarize(group.mean = mean(mean,na.rm=TRUE), 
                        sd=sd(mean), # standard deviation of across MPAs where indicator was observed/recorded. 
                        n=n()) %>% #no. MPA 'sites' where year is unit of rep
              pivot_wider(names_from = mpa_designation, #convert to wide format for {metafor}
              values_from = c(group.mean, sd, n)
              #names_glue = "{mpa_designation}_{value}")
)

#calculate region level means

region.means<- test.data%>%
  group_by(group,mlpa_region, mpa_designation,variable,indicator)%>%
  summarize(MPA_mean = mean(mean,na.rm=TRUE), 
            sd=sd(mean), # standard deviation of across MPAs where indicator was observed/recorded
            n=n())#no. MPA 'sites' where year is unit of rep
region.means
```

***Part 1 - Meta analyses using SMD***

#subset focal response metrics of interest
```{r}
state.biomass<- state.means %>%
  filter(variable=="Targetted Fish", indicator == "Biomass")

state.richness<- state.means %>%
  filter(variable=="all species", indicator == "richness")


state.diversity<- state.means %>%
  filter(variable=="all species", indicator == "diversity")

```

#prepare SMD and calculate effect size
#replace "data=" with subset data of interest. 
```{r}

smd_state <- escalc(measure="SMD", m1i=group.mean_MPA, m2i=group.mean_reference, sd1i=sd_MPA, sd2i=sd_reference, n1i=n_MPA, n2i=n_reference, data=state.biomass) 

smd.state.reml <- rma(yi,vi,method="REML", data=smd_state, slab=paste(group)) 

predint<-function(x,pi){
  alpha<-(1-(pi*.01))/2
  t<-abs(qt(alpha,(x$k-1)))
  sdp<- sqrt(x$se^2+x$tau2)
  lo<- x$b-(sdp*t)
  hi<- x$b+(sdp*t)
  paste(pi, "%prediction interval:",round(lo, digits=2), ",",round(hi, digits=2))
}

predint(smd.state.reml,95) 

```

#generate forest plot
```{r}
forest(smd.state.reml, order="obs")  
text(x =-2, y = 7.2, "Biomass",  pos=2, font=4)
text(x =-1, y = 6.5, "MPA",  pos=2, col="red", font=2)
text(x =2, y = 6.5, "REF",  pos=2, col="blue", font=2)
text(x=8.6, y=6.5,pos=2, "SMD", font=2)
text(x=11, y=6.5,pos=2, "[95% CI]", font=2)
```





**Part 2 - odds ratio test for pre/post regulatory implementation**
This analysis uses a t-test on before/after means and compares treatment (MPA) against control (REF) 

#calculate MPA-level means across all years 
```{r}
MPA.means<- test.data%>%
  group_by(group,mlpa_region, affiliated_mpa, mpa_designation,variable,indicator)%>%
  summarize(MPA_mean = mean(mean,na.rm=TRUE), 
            sd=sd(mean), # standard deviation of across MPAs where indicator was observed/recorded
            n=n())%>%#no. MPA 'sites' where year is unit of rep
            pivot_wider(names_from = mpa_designation, #convert to wide format for {metafor}
            values_from = c(MPA_mean, sd, n)
            #names_glue = "{mpa_designation}_{value}")
)
```

#create function to calculate t statistic using input means, rather than point data.
#one-tailed test for m2>m1 where m1=REF and m2=MPA
```{r}

# m1, m2: the sample means
# s1, s2: the sample standard deviations
# n1, n2: the same sizes
# m0: the null value for the difference in means to be tested for. Default is 0. 
# equal.variance: whether or not to assume equal variance. Default is FALSE. 

### vectorised function

t.test2 <- function(m1,m2,s1,s2,n1,n2,m0=0,equal.variance=FALSE)
{
  if(!equal.variance) 
  {
    se <- sqrt( (s1^2/n1) + (s2^2/n2) )
    # welch-satterthwaite df
    df <- ( (s1^2/n1 + s2^2/n2)^2 )/( (s1^2/n1)^2/(n1-1) + (s2^2/n2)^2/(n2-1) )
  } else
  {
    # pooled standard deviation, scaled by the sample sizes
    se <- sqrt( (1/n1 + 1/n2) * ((n1-1)*s1^2 + (n2-1)*s2^2)/(n1+n2-2) ) 
    df <- n1+n2-2
  }      
  t <- (m1-m2-m0)/se 
  dat <- vapply(seq_len(length(m1)), 
                function(x){c(m1[x]-m2[x], se[x], t[x], pt(-abs(t[x]),df[x]))}, #Right tailed m2 > m1. To test m1>m2, remove "-" in abs(). For two tailed, replace with "2*pt(-abs(t),df))". 
                numeric(4))  
  dat <- t(dat)
  dat <- as.data.frame(dat)
  names(dat) <- c("Difference of means", "Std Error", "t", "p.value")
  return(dat) 
} 
```

#t-test on m2>m1. Results could be structural or emergent effects. 
```{r}

t.output<-t.test2(MPA.means$MPA_mean_reference, MPA.means$MPA_mean_MPA, MPA.means$sd_reference, MPA.means$sd_MPA, MPA.means$n_reference, MPA.means$n_MPA)

(model.output<-as.data.frame(cbind(MPA.means,t.output)))
```

#now test for emergent MPA effects using pre-post regulatory protection means
```{r}

#calculate MPA means before and after regulatory implementation. n= no. years sampled. 
pre.post.means<- as.data.frame(test.data%>% 
  group_by(group, mlpa_region, affiliated_mpa, mpa_designation,variable,indicator,survey_period)%>%
  summarize(group.mean = mean(mean,na.rm=TRUE), 
            sd=sd(mean), # standard deviation of across MPA survey years. 
            n=n()) %>% #no. sampling years
  pivot_wider(names_from = survey_period, #convert to wide format for {metafor}
              values_from = c(group.mean, sd, n)
              #names_glue = "{mpa_designation}_{value}")
  ))


#conduct t-test and store results
t.output<-t.test2(pre.post.means$group.mean_Before, pre.post.means$group.mean_After, pre.post.means$sd_Before, pre.post.means$sd_After, pre.post.means$n_Before, pre.post.means$n_After)

(model.output<-as.data.frame(cbind(pre.post.means,t.output)))

#restructure model output for "OR" {metafor}
OR.table<- model.output%>%
  group_by(group,mpa_designation,variable,indicator)%>%
            summarise(
              n_rep = n(),
              sig = sum(p.value<0.05) #after > before
            )%>%
            pivot_wider(names_from = mpa_designation, #convert to wide format for {metafor}
              values_from = c(n_rep, sig))
```

#select focal response variable and indicators
```{r}
OR.biomass<- OR.table %>%
  filter(variable=="Targetted Fish", indicator == "Biomass")
```

#odds ratio meta analysis
```{r}
#OR_state <- escalc(measure="OR", ai=sig_MPA, bi=(n_rep_MPA-sig_MPA), ci=sig_reference, di=(n_rep_reference-sig_reference), data=OR.biomass)
OR_state <- escalc(measure="OR", ai=sig_reference, bi=(n_rep_reference), ci=sig_MPA, di=n_rep_MPA, data=OR.biomass)
or.rma <- rma(yi,vi,method="REML", data=OR_state, slab=paste(group))
forest(or.rma)
or.state.reml <- rma(yi,vi,method="REML", data=OR_state, slab=paste(group))



forest(or.state.reml, order="obs")  
text(x =-4, y = 7.5, "Biomass",  pos=2, font=4)
text(x =-1, y = 6.5, "MPA",  pos=2, col="red", font=2)
text(x =2.5, y = 6.5, "REF",  pos=2, col="blue", font=2)
text(x=8.6, y=6.5,pos=2, "SMD", font=2)
text(x=11, y=6.5,pos=2, "[95% CI]", font=2)
```



