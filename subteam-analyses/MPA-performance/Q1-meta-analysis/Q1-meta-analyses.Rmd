---
title: "CA MPA Performance Q1 meta analyses"
author: "Joshua G. Smith"
date: "3/30/2022"
output: html_document:
  toc:yes
  pdf_document:
    highlight: tango
    toc: yes
    toc_depth: 6
---

**required packages**
```{r load_libraries, message=FALSE}
library(ggplot2)
library(metafor)
library(forestplot)
library(dplyr)
library(tidyr)
library(reshape2)
```

Import and initialize data
```{r}
data_path <- "/home/shares/ca-mpa/data/sync-data"
input_file <- "Ecol_perform_metrics.xlsx" 

meta.data <- readxl::read_excel(file.path(data_path, input_file), sheet=1, skip = 0, na="NA")

```


Calculate means for each variable and indicator at the state and regional level
```{r}
#calculate state level means 
meta.data$mpa_designation<- recode_factor(meta.data$mpa_designation, SC="MPA", SMR_SMCA="MPA", SMCA="MPA",SMR="MPA") ###========consider "SMCA" and "SMR" as "MPA"========##
state.means<- meta.data%>% 
              group_by(group,mpa_designation,variable,indicator)%>%
              summarize(group.mean = mean(mean,na.rm=TRUE), 
                        sd=sd(mean), # standard deviation of across MPAs where indicator was observed/recorded. 
                        n=n()) %>% #no. MPA 'sites' where year is unit of rep
              pivot_wider(names_from = mpa_designation, #convert to wide format for {metafor}
              values_from = c(group.mean, sd, n)
              #names_glue = "{mpa_designation}_{value}")
)

#calculate region level means

region.means<- meta.data%>%
  group_by(group,mlpa_region, mpa_designation,variable,indicator)%>%
  summarize(group.mean = mean(mean,na.rm=TRUE), 
            sd=sd(mean), # standard deviation of across MPAs where indicator was observed/recorded
            n=n()) %>%
  pivot_wider(names_from = mpa_designation,
              values_from = c(group.mean, sd, n)
  )
     
region.means
```

***Part 1 - Meta analyses using SMD on state-level and regional regulatory status***


#subset focal response metrics of interest
```{r}
#state.biomass<- state.means %>%
  #filter(variable=="Targetted Fish", indicator == "Biomass")

#Diversity state level
state.means$indicator<- recode_factor(state.means$indicator, Diversity="diversity")

diversity.statelevel<- state.means %>%
  filter(variable=="all species"| variable=="All Fish",
           indicator == "diversity")

#Diversity region level
region.means$indicator<- recode_factor(region.means$indicator, Diversity="diversity")

diversity.north<- region.means %>%
  filter(mlpa_region=="North",
    variable=="all species"| variable=="All Fish",
           indicator == "diversity")

diversity.cen<- region.means %>%
  filter(mlpa_region=="Central",
    variable=="all species"| variable=="All Fish",
           indicator == "diversity")

diversity.south<- region.means %>%
  filter(mlpa_region=="South",
    variable=="all species"| variable=="All Fish",
           indicator == "diversity")


#Richness state level
state.means$indicator<- recode_factor(state.means$indicator, Richness="richness")

richness.statelevel<- state.means %>%
  filter(variable=="all species"| variable=="All Fish",
           indicator == "richness")

#Richness region level
region.means$indicator<- recode_factor(region.means$indicator, Richness="richness")

richness.north<- region.means %>%
  filter(mlpa_region=="North",
    variable=="all species"| variable=="All Fish",
           indicator == "richness")

richness.cen<- region.means %>%
  filter(mlpa_region=="Central",
    variable=="all species"| variable=="All Fish",
           indicator == "richness")

richness.south<- region.means %>%
  filter(mlpa_region=="South",
    variable=="all species"| variable=="All Fish",
           indicator == "richness")

```

#prepare SMD and calculate effect size for Diversity
#replace "data=" with subset data of interest. 
```{r}
#Diversity
#Overall state level
smd_state.H <- escalc(measure="SMD", m1i=group.mean_MPA, m2i=group.mean_REF, sd1i=sd_MPA, sd2i=sd_REF, n1i=n_MPA, n2i=n_REF, data=diversity.statelevel) 
smd.reml.H <- rma(yi,vi,method="REML", data=smd_state.H, slab=paste(group)) 


#North
smd_regionNorth.H <- escalc(measure="SMD", m1i=group.mean_MPA, m2i=group.mean_REF, sd1i=sd_MPA, sd2i=sd_REF, n1i=n_MPA, n2i=n_REF, data=diversity.north) 
smd.remlN.H <- rma(yi,vi,method="REML", data=smd_regionNorth.H, slab=paste(group)) 


#Central
smd_regionCen.H <- escalc(measure="SMD", m1i=group.mean_MPA, m2i=group.mean_REF, sd1i=sd_MPA, sd2i=sd_REF, n1i=n_MPA, n2i=n_REF, data=diversity.cen) 
smd.remlC.H <- rma(yi,vi,method="REML", data=smd_regionCen, slab=paste(group)) 

#South
smd_regionSouth.H <- escalc(measure="SMD", m1i=group.mean_MPA, m2i=group.mean_REF, sd1i=sd_MPA, sd2i=sd_REF, n1i=n_MPA, n2i=n_REF, data=diversity.south) 
smd.remlS.H <- rma(yi,vi,method="REML", data=smd_regionSouth, slab=paste(group)) 


predint<-function(x,pi){
  alpha<-(1-(pi*.01))/2
  t<-abs(qt(alpha,(x$k-1)))
  sdp<- sqrt(x$se^2+x$tau2)
  lo<- x$b-(sdp*t)
  hi<- x$b+(sdp*t)
  paste(pi, "%prediction interval:",round(lo, digits=2), ",",round(hi, digits=2))
}

predint(smd.reml.H,95) 
predint(smd.remlN.H,95) 
predint(smd.remlC.H,95)
predint(smd.remlS.H,95)

```



#prepare SMD and calculate effect size for richness
#replace "data=" with subset data of interest. 
```{r}
#Overall state level
smd_state.R <- escalc(measure="SMD", m1i=group.mean_MPA, m2i=group.mean_REF, sd1i=sd_MPA, sd2i=sd_REF, n1i=n_MPA, n2i=n_REF, data=richness.statelevel) 
smd.reml.R <- rma(yi,vi,method="REML", data=smd_state.R, slab=paste(group)) 


#North
smd_regionNorth.R <- escalc(measure="SMD", m1i=group.mean_MPA, m2i=group.mean_REF, sd1i=sd_MPA, sd2i=sd_REF, n1i=n_MPA, n2i=n_REF, data=richness.north) 
smd.remlN.R <- rma(yi,vi,method="REML", data=smd_regionNorth.R, slab=paste(group)) 


#Central
smd_regionCen.R <- escalc(measure="SMD", m1i=group.mean_MPA, m2i=group.mean_REF, sd1i=sd_MPA, sd2i=sd_REF, n1i=n_MPA, n2i=n_REF, data=richness.cen) 
smd.remlC.R <- rma(yi,vi,method="REML", data=smd_regionCen.R, slab=paste(group)) 

#South
smd_regionSouth.R <- escalc(measure="SMD", m1i=group.mean_MPA, m2i=group.mean_REF, sd1i=sd_MPA, sd2i=sd_REF, n1i=n_MPA, n2i=n_REF, data=richness.south) 
smd.remlS.R <- rma(yi,vi,method="REML", data=smd_regionSouth.R, slab=paste(group)) 


predint<-function(x,pi){
  alpha<-(1-(pi*.01))/2
  t<-abs(qt(alpha,(x$k-1)))
  sdp<- sqrt(x$se^2+x$tau2)
  lo<- x$b-(sdp*t)
  hi<- x$b+(sdp*t)
  paste(pi, "%prediction interval:",round(lo, digits=2), ",",round(hi, digits=2))
}

predint(smd.reml.R,95) 
predint(smd.remlN.R,95) 
predint(smd.remlC.R,95)
predint(smd.remlS.R,95)

```



#generate forest plots for diversity
```{r}

forest(smd.reml.H, order="obs", xlim=c(-1.7,2.5), ylim=c(-2,8), cex=1)  
text(x =-0.8, y = 7, "Diversity Overall",  pos=2, font=4, cex=1)
text(x =-0.3, y = 6.5, "REF",  pos=2, col="blue", font=2)
text(x =0.6, y = 6.5, "MPA",  pos=2, col="red ", font=2)
text(x=1.95, y=6.5,pos=2, "SMD", font=2)
text(x=2.5, y=6.5,pos=2, "[95% CI]", font=2)

forest(smd.remlN.H, order="obs", xlim=c(-1.7,2.5), ylim=c(-2,8), cex=1)  
text(x =-1, y = 7, "Diversity North",  pos=2, font=4, cex=1)
text(x =-0.3, y = 6.5, "REF",  pos=2, col="blue", font=2)
text(x =0.6, y = 6.5, "MPA",  pos=2, col="red ", font=2)
text(x=1.95, y=6.5,pos=2, "SMD", font=2)
text(x=2.5, y=6.5,pos=2, "[95% CI]", font=2)

forest(smd.remlC.H, order="obs", xlim=c(-1.6,2.5), ylim=c(-2,8), cex=1)  
text(x =-0.6, y = 7, "Diversity Central",  pos=2, font=4, cex=1)
text(x =-0.3, y = 6.5, "REF",  pos=2, col="blue", font=2)
text(x =0.6, y = 6.5, "MPA",  pos=2, col="red ", font=2)
text(x=1.95, y=6.5,pos=2, "SMD", font=2)
text(x=2.5, y=6.5,pos=2, "[95% CI]", font=2)

forest(smd.remlS.H, order="obs", xlim=c(-1.6,2.5), ylim=c(-2,8), cex=1)  
text(x =-0.6, y = 7, "Diversity South",  pos=2, font=4, cex=1)
text(x =-0.3, y = 6.5, "REF",  pos=2, col="blue", font=2)
text(x =0.6, y = 6.5, "MPA",  pos=2, col="red ", font=2)
text(x=1.95, y=6.5,pos=2, "SMD", font=2)
text(x=2.5, y=6.5,pos=2, "[95% CI]", font=2)
```

#generate forest plots for richness
```{r}

forest(smd.reml.R, order="obs", xlim=c(-1.7,2.5), ylim=c(-2,8), cex=1)  
text(x =-0.8, y = 7, "Richness Overall",  pos=2, font=4, cex=1)
text(x =-0.3, y = 6.5, "REF",  pos=2, col="blue", font=2)
text(x =0.6, y = 6.5, "MPA",  pos=2, col="red ", font=2)
text(x=1.95, y=6.5,pos=2, "SMD", font=2)
text(x=2.5, y=6.5,pos=2, "[95% CI]", font=2)

forest(smd.remlN.R, order="obs", xlim=c(-1.7,2.5), ylim=c(-2,8), cex=1)  
text(x =-1, y = 7, "Richness North",  pos=2, font=4, cex=1)
text(x =-0.3, y = 6.5, "REF",  pos=2, col="blue", font=2)
text(x =0.6, y = 6.5, "MPA",  pos=2, col="red ", font=2)
text(x=1.95, y=6.5,pos=2, "SMD", font=2)
text(x=2.5, y=6.5,pos=2, "[95% CI]", font=2)

forest(smd.remlC.R, order="obs", xlim=c(-1.6,2.5), ylim=c(-2,8), cex=1)  
text(x =-0.6, y = 7, "Richness Central",  pos=2, font=4, cex=1)
text(x =-0.3, y = 6.5, "REF",  pos=2, col="blue", font=2)
text(x =0.6, y = 6.5, "MPA",  pos=2, col="red ", font=2)
text(x=1.95, y=6.5,pos=2, "SMD", font=2)
text(x=2.5, y=6.5,pos=2, "[95% CI]", font=2)

forest(smd.remlS.R, order="obs", xlim=c(-1.6,2.5), ylim=c(-2,8), cex=1)  
text(x =-0.6, y = 7, "Richness South",  pos=2, font=4, cex=1)
text(x =-0.3, y = 6.5, "REF",  pos=2, col="blue", font=2)
text(x =0.6, y = 6.5, "MPA",  pos=2, col="red ", font=2)
text(x=1.95, y=6.5,pos=2, "SMD", font=2)
text(x=2.5, y=6.5,pos=2, "[95% CI]", font=2)
```






**Part 2 - odds ratio test for pre/post regulatory implementation**
This analysis uses a t-test on before/after means and compares treatment (MPA) against control (REF) 

#calculate MPA-level means across all years 
```{r}
MPA.means<- meta.data%>%
  group_by(group,mlpa_region, affiliated_mpa, mpa_designation,variable,indicator)%>%
  summarize(MPA_mean = mean(mean,na.rm=TRUE), 
            sd=sd(mean), # standard deviation of across MPAs where indicator was observed/recorded
            n=n())%>%#no. MPA 'sites' where year is unit of rep
            pivot_wider(names_from = mpa_designation, #convert to wide format for {metafor}
            values_from = c(MPA_mean, sd, n)
            #names_glue = "{mpa_designation}_{value}")
)
MPA.means
```

#create function to calculate t statistic using input means, rather than point data.
#function is for one-tailed test for m2>m1 where m1=REF and m2=MPA
```{r}

# m1, m2: the sample means
# s1, s2: the sample standard deviations
# n1, n2: the same sizes
# m0: the null value for the difference in means to be tested for. Default is 0. 
# equal.variance: whether or not to assume equal variance. Default is FALSE. 

### vectorised function

t.test2 <- function(m1,m2,s1,s2,n1,n2,m0=0,equal.variance=FALSE)
{
  if(!equal.variance) 
  {
    se <- sqrt( (s1^2/n1) + (s2^2/n2) )
    # welch-satterthwaite df
    df <- ( (s1^2/n1 + s2^2/n2)^2 )/( (s1^2/n1)^2/(n1-1) + (s2^2/n2)^2/(n2-1) )
  } else
  {
    # pooled standard deviation, scaled by the sample sizes
    se <- sqrt( (1/n1 + 1/n2) * ((n1-1)*s1^2 + (n2-1)*s2^2)/(n1+n2-2) ) 
    df <- n1+n2-2
  }      
  t <- (m1-m2-m0)/se 
  dat <- vapply(seq_len(length(m1)), 
                function(x){c(m1[x]-m2[x], se[x], t[x], pt(-abs(t[x]),df[x]))}, #Right tailed m2 > m1. To test m1>m2, remove "-" in abs(). For two tailed, replace with "2*pt(-abs(t),df))". 
                numeric(4))  
  dat <- t(dat)
  dat <- as.data.frame(dat)
  names(dat) <- c("Difference of means", "Std Error", "t", "p.value")
  return(dat) 
} 
```

#t-test on m2>m1. Results could be structural or emergent effects. 
```{r}

t.output<-t.test2(MPA.means$MPA_mean_REF, MPA.means$MPA_mean_MPA, MPA.means$sd_REF, MPA.means$sd_MPA, MPA.means$n_REF, MPA.means$n_MPA)

(model.output<-as.data.frame(cbind(MPA.means,t.output)))
```

#now test for emergent MPA effects using pre-post regulatory protection means
```{r}

#calculate MPA means before and after regulatory implementation. n= no. years sampled. 
pre.post.means<- as.data.frame(meta.data%>% 
  group_by(group, mlpa_region, affiliated_mpa, mpa_designation,variable,indicator,survey_period)%>%
  summarize(group.mean = mean(mean,na.rm=TRUE), 
            sd=sd(mean), # standard deviation of across MPA survey years. 
            n=n()) %>% #no. sampling years
  pivot_wider(names_from = survey_period, #convert to wide format for {metafor}
              values_from = c(group.mean, sd, n)
              #names_glue = "{mpa_designation}_{value}")
  ))


#conduct t-test and store results
t.output<-t.test2(pre.post.means$group.mean_before, pre.post.means$group.mean_after, pre.post.means$sd_before, pre.post.means$sd_after, pre.post.means$n_before, pre.post.means$n_after)

(model.output<-as.data.frame(cbind(pre.post.means,t.output)))

#restructure model output for "OR" {metafor}

OR.table<- model.output%>%
  group_by(group,mpa_designation,variable,indicator)%>%
            summarise(
              n_rep = n(),
              sig = sum(p.value<0.05) #after > before
            )%>%
            pivot_wider(names_from = mpa_designation, #convert to wide format for {metafor}
              values_from = c(n_rep, sig))
```

#select focal response variable and indicators
```{r}
OR.table$indicator<- recode_factor(state.means$indicator, Diversity="diversity")
OR.table$indicator<- recode_factor(state.means$indicator, Richness="richness")
OR.diversity<- OR.table %>%
  filter(variable=="All Fish", 
         variable=="all species",
         indicator == "Diversity")
```

#odds ratio meta analysis
```{r}
#OR_state <- escalc(measure="OR", ai=sig_MPA, bi=(n_rep_MPA-sig_MPA), ci=sig_reference, di=(n_rep_reference-sig_reference), data=OR.biomass)
OR_state <- escalc(measure="OR", ai=sig_REF, bi=n_rep_REF, ci=sig_MPA, di=n_rep_MPA, data=OR.diversity)
or.rma <- rma(yi,vi,method="REML", data=OR_state, slab=paste(group))
forest(or.rma)
or.state.reml <- rma(yi,vi,method="REML", data=OR_state, slab=paste(group))



forest(or.state.reml, order="obs")  
text(x =-4, y = 7.5, "Biomass",  pos=2, font=4)
text(x =-1, y = 6.5, "MPA",  pos=2, col="red", font=2)
text(x =2.5, y = 6.5, "REF",  pos=2, col="blue", font=2)
text(x=8.6, y=6.5,pos=2, "SMD", font=2)
text(x=11, y=6.5,pos=2, "[95% CI]", font=2)
```




